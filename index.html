<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D&D Voice Adventure - A comprehensive tabletop RPG companion with voice integration, inspired by Baldur's Gate 3 and Gloomhaven.">
    <meta name="keywords" content="D&D, Dungeons Dragons, RPG, tabletop, voice, adventure, campaign">
    <meta name="author" content="D&D Voice Adventure">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://taylor834-sketch.github.io/AI-DND-DM/">
    <meta property="og:title" content="D&D Voice Adventure">
    <meta property="og:description" content="Experience immersive tabletop RPG adventures with voice integration and atmospheric storytelling.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://taylor834-sketch.github.io/AI-DND-DM/"
    <meta property="twitter:title" content="D&D Voice Adventure">
    <meta property="twitter:description" content="Experience immersive tabletop RPG adventures with voice integration and atmospheric storytelling.">
    
    <title>D&D Voice Adventure</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="./css/main.css">
    
    <!-- Error Styles -->
    <style>
        .critical-error {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: #1a1a1a;
            border: 2px solid #ff4444;
            border-radius: 10px;
            color: white;
            font-family: 'Crimson Text', serif;
        }
        .critical-error h2 {
            color: #ff6666;
            margin-top: 0;
        }
        .error-help {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .error-help h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        .error-help code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        .error-actions {
            margin-top: 20px;
        }
        .error-actions button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .error-actions button:hover {
            background: #45a049;
        }
        .error-actions button:nth-child(2) {
            background: #2196F3;
        }
        .error-actions button:nth-child(2):hover {
            background: #1976D2;
        }
    </style>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./js/core.js" as="script">
    <link rel="preload" href="./css/main.css" as="style">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="dragon-symbol">üêâ</div>
            <h1 class="loading-title">D&D Voice Adventure</h1>
            <div class="loading-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
            <p class="loading-text" id="loading-text">Awakening ancient powers...</p>
        </div>
    </div>

    <!-- Error Container for Critical Errors -->
    <div id="error-container" class="error-container" style="display: none;"></div>

    <!-- Main Application Container -->
    <div id="app" class="app-container">
        <!-- Main Menu Screen -->
        <div id="mainMenu-screen" class="screen main-menu-screen active">
            <!-- Background Elements -->
            <div class="background-overlay"></div>
            <div class="particle-container" id="particle-container"></div>
            
            <!-- Header -->
            <header class="main-header">
                <div class="title-container">
                    <h1 class="main-title">
                        <span class="title-primary">D&D Voice</span>
                        <span class="title-secondary">Adventure</span>
                    </h1>
                    <p class="subtitle">Embark on Epic Journeys</p>
                </div>
            </header>

            <!-- Main Menu Navigation -->
            <nav class="main-menu">
                <div class="menu-container">
                    <button id="create-campaign-btn" class="menu-button primary-button">
                        <span class="button-icon">‚öîÔ∏è</span>
                        <span class="button-text">Create New Campaign</span>
                        <span class="button-description">Begin a fresh adventure</span>
                    </button>

                    <button id="continue-campaign-btn" class="menu-button secondary-button">
                        <span class="button-icon">üìñ</span>
                        <span class="button-text">Continue Campaign</span>
                        <span class="button-description">Resume your journey</span>
                    </button>

                    <button id="load-github-btn" class="menu-button secondary-button">
                        <span class="button-icon">‚òÅÔ∏è</span>
                        <span class="button-text">Load from GitHub</span>
                        <span class="button-description">Sync your adventures</span>
                    </button>

                    <button id="world-browser-btn" class="menu-button secondary-button">
                        <span class="button-icon">üåç</span>
                        <span class="button-text">World Browser</span>
                        <span class="button-description">Explore NPCs, locations, and lore</span>
                    </button>

                    <button id="settings-btn" class="menu-button tertiary-button">
                        <span class="button-icon">‚öôÔ∏è</span>
                        <span class="button-text">Settings</span>
                        <span class="button-description">Configure your experience</span>
                    </button>
                </div>
            </nav>

            <!-- Footer -->
            <footer class="main-footer">
                <div class="footer-content">
                    <p class="version-info">Version <span id="app-version">1.0.0</span></p>
                    <p class="github-link">
                        <a href="https://github.com/taylor834-sketch/AI-DND-DM" target="_blank" rel="noopener noreferrer">
                            View on GitHub
                        </a>
                    </p>
                </div>
            </footer>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen settings-screen">
            <div class="settings-container">
                <header class="screen-header">
                    <h2>Settings</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>
                
                <div class="settings-content">
                    <div class="settings-section">
                        <h3>Audio</h3>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="enable-audio"> Enable Audio Effects
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                Master Volume
                                <input type="range" id="master-volume" min="0" max="100" value="70">
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Display</h3>
                        <div class="setting-item">
                            <label>
                                <select id="theme-select">
                                    <option value="dark">Dark Theme</option>
                                    <option value="light">Light Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                                Theme
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="enable-particles" checked> Enable Particles
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>GitHub Integration</h3>
                        <div class="setting-item">
                            <label>
                                GitHub Token
                                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                Repository
                                <input type="text" id="github-repo" placeholder="username/dnd-campaigns">
                            </label>
                        </div>
                        <button id="test-github-connection" class="secondary-button">Test Connection</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign List Screen -->
        <div id="campaignList-screen" class="screen campaign-list-screen">
            <div class="screen-header">
                <h2>Continue Campaign</h2>
                <button class="back-button" onclick="promptToSave('mainMenu')">‚Üê Back</button>
            </div>
            <div class="campaign-list-container">
                <div id="campaign-list-content">
                    <!-- Campaigns will be populated here -->
                </div>
            </div>
        </div>

        <!-- Campaign Creation Screen -->
        <div id="campaignCreation-screen" class="screen campaign-creation-screen">
            <div class="campaign-creation-container">
                <header class="screen-header">
                    <h2>Create New Campaign</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>
                
                <form id="campaign-creation-form" class="campaign-form" onsubmit="createCampaign(event); return false;">
                    <div class="form-section">
                        <h3>Campaign Details</h3>
                        
                        <div class="form-group">
                            <label for="campaign-name">Campaign Name *</label>
                            <input type="text" id="campaign-name" name="campaignName" required 
                                   placeholder="The Shattered Crown" maxlength="50">
                            <small>Give your adventure a memorable name</small>
                        </div>

                        <div class="form-group">
                            <label for="world-seed">World Seed</label>
                            <input type="text" id="world-seed" name="worldSeed" 
                                   placeholder="mystical_forests_47291" maxlength="30">
                            <small>Optional: Custom seed for world generation (leave blank for random)</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Campaign Style</h3>
                        
                        <div class="form-group">
                            <label for="moral-complexity">Moral Complexity</label>
                            <select id="moral-complexity" name="moralComplexity" required>
                                <option value="simple">Simple - Clear good vs evil</option>
                                <option value="nuanced" selected>Nuanced - Shades of gray with clear consequences</option>
                                <option value="morally_gray">Morally Gray - Complex choices with no clear right answer</option>
                            </select>
                            <small>How complex should moral decisions be in your campaign?</small>
                        </div>

                        <div class="form-group">
                            <label for="starting-region">Starting Region</label>
                            <select id="starting-region" name="startingRegion" required>
                                <option value="sword_coast">Sword Coast - Classic D&D adventure region</option>
                                <option value="underdark">Underdark - Dark underground realm</option>
                                <option value="feywild">Feywild - Magical fey realm</option>
                                <option value="shadowfell">Shadowfell - Dark reflection of the material plane</option>
                                <option value="elemental_planes">Elemental Planes - Raw elemental forces</option>
                                <option value="custom">Custom Region</option>
                            </select>
                            <small>Choose the starting location for your adventure</small>
                        </div>

                        <div class="form-group" id="custom-region-group" style="display: none;">
                            <label for="custom-region-name">Custom Region Name</label>
                            <input type="text" id="custom-region-name" name="customRegionName" 
                                   placeholder="The Forgotten Realms" maxlength="40">
                            <small>Name your custom starting region</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Starting Scenario</h3>
                        <div class="scenario-selection">
                            <div class="scenario-option selected" data-scenario="mysterious_caravan" onclick="selectScenario('mysterious_caravan')">
                                <div class="scenario-header">
                                    <h4>üöö The Mysterious Caravan</h4>
                                    <span class="scenario-difficulty">Beginner</span>
                                </div>
                                <p>A merchant caravan has gone missing on the trade routes. Investigate their disappearance and uncover a web of intrigue.</p>
                                <div class="scenario-features">
                                    <span class="feature">Investigation</span>
                                    <span class="feature">Social Encounters</span>
                                    <span class="feature">Mystery</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="goblin_raids" onclick="selectScenario('goblin_raids')">
                                <div class="scenario-header">
                                    <h4>‚öîÔ∏è Goblin Raids</h4>
                                    <span class="scenario-difficulty">Beginner</span>
                                </div>
                                <p>Goblin raiders threaten a peaceful village. Rally the townsfolk and drive back the goblin menace.</p>
                                <div class="scenario-features">
                                    <span class="feature">Combat</span>
                                    <span class="feature">Tactics</span>
                                    <span class="feature">Community</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="ancient_ruins" onclick="selectScenario('ancient_ruins')">
                                <div class="scenario-header">
                                    <h4>üèõÔ∏è The Ancient Ruins</h4>
                                    <span class="scenario-difficulty">Intermediate</span>
                                </div>
                                <p>Explore forgotten ruins filled with traps, puzzles, and ancient guardians protecting lost treasures.</p>
                                <div class="scenario-features">
                                    <span class="feature">Exploration</span>
                                    <span class="feature">Puzzles</span>
                                    <span class="feature">Treasure</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="political_intrigue" onclick="selectScenario('political_intrigue')">
                                <div class="scenario-header">
                                    <h4>üëë Court of Shadows</h4>
                                    <span class="scenario-difficulty">Advanced</span>
                                </div>
                                <p>Navigate the dangerous waters of noble court politics, where words are weapons and alliances shift like shadows.</p>
                                <div class="scenario-features">
                                    <span class="feature">Roleplay</span>
                                    <span class="feature">Intrigue</span>
                                    <span class="feature">Politics</span>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selected-scenario" name="startingScenario" value="mysterious_caravan">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="secondary-button" onclick="promptToSave('mainMenu')">
                            Cancel
                        </button>
                        <button type="submit" class="primary-button">
                            <span class="button-icon">‚ú®</span>
                            Create Campaign
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Character Setup Screen -->
        <div id="characterSetup-screen" class="screen character-setup-screen">
            <div class="character-setup-container">
                <header class="screen-header">
                    <h2>Character Setup</h2>
                    <div class="header-actions">
                        <button id="import-character-btn" class="secondary-button">Import from D&D Beyond</button>
                        <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                    </div>
                </header>

                <!-- Import Character Modal -->
                <div id="import-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Import D&D Beyond Character</h3>
                            <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <p>Copy and paste your character sheet text from D&D Beyond:</p>
                            <textarea id="character-import-text" placeholder="Paste your D&D Beyond character sheet here..." rows="10"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                            <button id="parse-character-btn" class="primary-button">Parse Character</button>
                        </div>
                    </div>
                </div>

                <!-- Party Management -->
                <div class="party-management">
                    <h3>Party Members</h3>
                    <div id="party-list" class="party-list">
                        <div class="empty-party">
                            <p>No characters in party. Import or create characters to get started.</p>
                            <button class="primary-button" onclick="document.getElementById('import-modal').style.display='flex'">
                                <span class="button-icon">üë•</span>
                                Add First Character
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Character Actions -->
                <div class="character-actions" id="character-actions" style="display: none;">
                    <button id="continue-to-game-btn" class="primary-button">
                        <span class="button-icon">üéÆ</span>
                        Continue to Game
                    </button>
                </div>
            </div>
        </div>

        <!-- Character Sheet Screen -->
        <div id="characterSheet-screen" class="screen character-sheet-screen">
            <div class="character-sheet-container">
                <header class="character-sheet-header">
                    <div class="character-name-section">
                        <h2 id="character-name">Character Name</h2>
                        <div class="character-basics">
                            <span id="character-class-level">Class Level</span>
                            <span id="character-race">Race</span>
                        </div>
                    </div>
                    <div class="party-switcher">
                        <select id="character-switcher">
                            <option>Select Character</option>
                        </select>
                    </div>
                    <div class="header-actions">
                        <button id="save-character-btn" class="secondary-button">Save</button>
                        <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                    </div>
                </header>

                <!-- Character Sheet Tabs -->
                <div class="character-tabs">
                    <button class="tab-button active" data-tab="overview">Overview</button>
                    <button class="tab-button" data-tab="abilities">Abilities</button>
                    <button class="tab-button" data-tab="skills">Skills</button>
                    <button class="tab-button" data-tab="inventory">Inventory</button>
                    <button class="tab-button" data-tab="spells">Spells</button>
                    <button class="tab-button" data-tab="features">Features</button>
                    <button class="tab-button" data-tab="relationships">Relationships</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div id="overview-tab" class="tab-panel active">
                        <div class="overview-grid">
                            <div class="vital-stats">
                                <h3>Vital Stats</h3>
                                <div class="stat-row">
                                    <label>Armor Class</label>
                                    <span id="ac-value">10</span>
                                </div>
                                <div class="stat-row">
                                    <label>Hit Points</label>
                                    <div class="hp-section">
                                        <input type="number" id="current-hp" min="0">
                                        <span>/</span>
                                        <span id="max-hp">1</span>
                                    </div>
                                </div>
                                <div class="stat-row">
                                    <label>Speed</label>
                                    <span id="speed-value">30 ft</span>
                                </div>
                                <div class="stat-row">
                                    <label>Proficiency Bonus</label>
                                    <span id="prof-bonus">+2</span>
                                </div>
                            </div>

                            <div class="ability-overview">
                                <h3>Ability Scores</h3>
                                <div class="ability-grid">
                                    <div class="ability-score">
                                        <div class="ability-name">STR</div>
                                        <div class="ability-value" id="str-score">10</div>
                                        <div class="ability-modifier" id="str-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">DEX</div>
                                        <div class="ability-value" id="dex-score">10</div>
                                        <div class="ability-modifier" id="dex-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">CON</div>
                                        <div class="ability-value" id="con-score">10</div>
                                        <div class="ability-modifier" id="con-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">INT</div>
                                        <div class="ability-value" id="int-score">10</div>
                                        <div class="ability-modifier" id="int-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">WIS</div>
                                        <div class="ability-value" id="wis-score">10</div>
                                        <div class="ability-modifier" id="wis-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">CHA</div>
                                        <div class="ability-value" id="cha-score">10</div>
                                        <div class="ability-modifier" id="cha-mod">+0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="character-info">
                                <h3>Character Information</h3>
                                <div class="info-row">
                                    <label>Background:</label>
                                    <span id="character-background">Unknown</span>
                                </div>
                                <div class="info-row">
                                    <label>Alignment:</label>
                                    <span id="character-alignment">Unknown</span>
                                </div>
                                <div class="info-row">
                                    <label>Experience:</label>
                                    <span id="character-xp">0 XP</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Abilities Tab -->
                    <div id="abilities-tab" class="tab-panel">
                        <div class="abilities-content">
                            <div class="saving-throws">
                                <h3>Saving Throws</h3>
                                <div id="saving-throws-list" class="saves-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="ability-details">
                                <h3>Ability Score Details</h3>
                                <div id="ability-details-list" class="ability-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Tab -->
                    <div id="skills-tab" class="tab-panel">
                        <h3>Skills</h3>
                        <div id="skills-list" class="skills-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Inventory Tab -->
                    <div id="inventory-tab" class="tab-panel">
                        <div class="inventory-content">
                            <div class="weapons-section">
                                <h3>Weapons</h3>
                                <div id="weapons-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="armor-section">
                                <h3>Armor</h3>
                                <div id="armor-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="items-section">
                                <h3>Items</h3>
                                <div id="items-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="currency-section">
                                <h3>Currency</h3>
                                <div class="currency-grid">
                                    <div class="coin"><span class="coin-type">CP</span><span id="cp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">SP</span><span id="sp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">EP</span><span id="ep-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">GP</span><span id="gp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">PP</span><span id="pp-amount">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Spells Tab -->
                    <div id="spells-tab" class="tab-panel">
                        <div class="spells-content">
                            <div class="spellcasting-info">
                                <h3>Spellcasting</h3>
                                <div class="spell-stats">
                                    <div class="spell-stat">
                                        <label>Spellcasting Ability</label>
                                        <span id="spellcasting-ability">None</span>
                                    </div>
                                    <div class="spell-stat">
                                        <label>Spell Save DC</label>
                                        <span id="spell-save-dc">8</span>
                                    </div>
                                    <div class="spell-stat">
                                        <label>Spell Attack Bonus</label>
                                        <span id="spell-attack-bonus">+0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="spell-slots">
                                <h3>Spell Slots</h3>
                                <div id="spell-slots-list" class="slots-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="spells-known">
                                <h3>Spells Known</h3>
                                <div id="spells-list" class="spells-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Features Tab -->
                    <div id="features-tab" class="tab-panel">
                        <h3>Features & Traits</h3>
                        <div id="features-list" class="features-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div id="relationships-tab" class="tab-panel">
                        <div class="relationships-content">
                            <div class="backstory-section">
                                <h3>Backstory</h3>
                                <div class="backstory-item">
                                    <label>Personality Traits:</label>
                                    <div id="personality-traits" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Ideals:</label>
                                    <div id="ideals" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Bonds:</label>
                                    <div id="bonds" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Flaws:</label>
                                    <div id="flaws" class="trait-list"></div>
                                </div>
                            </div>
                            <div class="notes-section">
                                <h3>Notes</h3>
                                <textarea id="character-notes" placeholder="Character notes and relationships..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Browser Screen -->
        <div id="worldBrowser-screen" class="screen world-browser-screen">
            <div class="world-browser-container">
                <header class="screen-header">
                    <h2>World Browser</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>

                <!-- Search and Filters -->
                <div class="world-browser-filters">
                    <div class="search-section">
                        <input type="text" id="world-search" placeholder="Search NPCs, locations, factions, events..." class="search-input">
                        <button id="search-btn" class="search-button">üîç</button>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>Category:</label>
                            <select id="category-filter">
                                <option value="all">All</option>
                                <option value="npcs">NPCs</option>
                                <option value="locations">Locations</option>
                                <option value="factions">Factions</option>
                                <option value="events">Events</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Region:</label>
                            <select id="region-filter">
                                <option value="all">All Regions</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Status:</label>
                            <select id="status-filter">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="hostile">Hostile</option>
                                <option value="friendly">Friendly</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- World Browser Tabs -->
                <div class="world-browser-tabs">
                    <button class="world-tab-button active" data-tab="all">All</button>
                    <button class="world-tab-button" data-tab="npcs">NPCs</button>
                    <button class="world-tab-button" data-tab="locations">Locations</button>
                    <button class="world-tab-button" data-tab="factions">Factions</button>
                    <button class="world-tab-button" data-tab="events">Events</button>
                    <button class="world-tab-button" data-tab="timeline">Timeline</button>
                    <button class="world-tab-button" data-tab="relationships">Relationships</button>
                </div>

                <!-- Tab Content -->
                <div class="world-tab-content">
                    <!-- All Tab -->
                    <div id="all-world-tab" class="world-tab-panel active">
                        <div id="all-results" class="world-results-grid">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- NPCs Tab -->
                    <div id="npcs-world-tab" class="world-tab-panel">
                        <div class="npc-section">
                            <div class="section-header">
                                <h3>Non-Player Characters</h3>
                                <button id="add-npc-btn" class="add-button">+ Add NPC</button>
                            </div>
                            <div id="npc-results" class="npc-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Locations Tab -->
                    <div id="locations-world-tab" class="world-tab-panel">
                        <div class="location-section">
                            <div class="section-header">
                                <h3>Locations</h3>
                                <button id="add-location-btn" class="add-button">+ Add Location</button>
                            </div>
                            <div id="location-results" class="location-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Factions Tab -->
                    <div id="factions-world-tab" class="world-tab-panel">
                        <div class="faction-section">
                            <div class="section-header">
                                <h3>Factions</h3>
                                <button id="add-faction-btn" class="add-button">+ Add Faction</button>
                            </div>
                            <div id="faction-results" class="faction-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Events Tab -->
                    <div id="events-world-tab" class="world-tab-panel">
                        <div class="event-section">
                            <div class="section-header">
                                <h3>Events</h3>
                                <button id="add-event-btn" class="add-button">+ Add Event</button>
                            </div>
                            <div id="event-results" class="event-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div id="timeline-world-tab" class="world-tab-panel">
                        <div class="timeline-section">
                            <h3>Campaign Timeline</h3>
                            <div class="timeline-controls">
                                <button id="timeline-filter-major" class="timeline-filter">Major Events</button>
                                <button id="timeline-filter-all" class="timeline-filter active">All Events</button>
                                <select id="timeline-date-range">
                                    <option value="all">All Time</option>
                                    <option value="recent">Last 30 Days</option>
                                    <option value="session">Current Session</option>
                                </select>
                            </div>
                            <div id="timeline-results" class="timeline-container">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div id="relationships-world-tab" class="world-tab-panel">
                        <div class="relationships-section">
                            <h3>Relationship Map</h3>
                            <div class="relationship-controls">
                                <select id="relationship-focus">
                                    <option value="all">Show All Relationships</option>
                                    <option value="party">Party Connections</option>
                                    <option value="factions">Faction Networks</option>
                                    <option value="locations">Location Connections</option>
                                </select>
                                <button id="relationship-reset" class="secondary-button">Reset View</button>
                            </div>
                            <div id="relationship-map" class="relationship-map">
                                <!-- Populated by JavaScript with visual relationship mapping -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Entity Detail Modal -->
        <div id="world-detail-modal" class="modal" style="display: none;">
            <div class="modal-content world-detail-content">
                <div class="modal-header">
                    <h3 id="detail-title">Entity Details</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body" id="detail-body">
                    <!-- Populated by JavaScript based on entity type -->
                </div>
                <div class="modal-footer">
                    <button id="edit-entity-btn" class="secondary-button">Edit</button>
                    <button class="primary-button" onclick="this.closest('.modal').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Entity Modal -->
        <div id="entity-form-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="entity-form-title">Add Entity</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="entity-form">
                        <div id="entity-form-fields">
                            <!-- Populated dynamically based on entity type -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                    <button id="save-entity-btn" class="primary-button">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen game-screen">
            <div class="game-container">
                <header class="game-header">
                    <h2>D&D Adventure</h2>
                    <div class="game-controls">
                        <button class="secondary-button" onclick="switchScreen('characterSheet')">Character Sheet</button>
                        <button class="secondary-button" onclick="switchScreen('worldBrowser')">World Browser</button>
                        <button class="secondary-button" onclick="promptToSave('mainMenu')">Main Menu</button>
                    </div>
                </header>
                
                <div class="game-content">
                    <!-- AI DM Conversation Interface -->
                    <div class="dm-conversation">
                        <div class="conversation-header">
                            <h3>üé≤ Adventure Story</h3>
                            <button class="secondary-button" onclick="startNewStoryBeat()">New Scene</button>
                        </div>
                        
                        <div id="conversation-history" class="conversation-history">
                            <!-- Conversation history will be populated here -->
                        </div>
                        
                        <div class="player-input-section">
                            <div class="voice-controls">
                                <div class="voice-status">
                                    <div id="voice-status-indicator" class="voice-indicator">
                                        <span id="voice-status-text">Ready to listen</span>
                                        <div id="voice-animation" class="voice-animation"></div>
                                    </div>
                                </div>
                                
                                <div class="voice-buttons">
                                    <button id="start-listening-btn" class="voice-button primary-button" onclick="startListening()">
                                        üé§ Speak Action
                                    </button>
                                    <button id="stop-listening-btn" class="voice-button secondary-button" onclick="stopListening()" style="display: none;">
                                        ‚èπÔ∏è Stop
                                    </button>
                                    <button class="voice-button secondary-button" onclick="toggleDMVoice()">
                                        <span id="dm-voice-toggle">üîä DM Voice: ON</span>
                                    </button>
                                    <button class="voice-button secondary-button" onclick="openVoiceSettings()">
                                        ‚öôÔ∏è Voice Settings
                                    </button>
                                    <button class="voice-button secondary-button" onclick="openAIDMSettings()">
                                        ü§ñ AI Settings
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-fallback">
                                <details>
                                    <summary>Or type your action (fallback)</summary>
                                    <div class="input-group">
                                        <textarea id="player-input" placeholder="What do you do? Describe your actions..." rows="2"></textarea>
                                        <div class="input-actions">
                                            <button class="secondary-button" onclick="sendPlayerAction()">Send Text</button>
                                            <button class="secondary-button" onclick="rollDice()">üé≤ Roll Dice</button>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-sidebar">
                        <div class="party-status">
                            <h4>Party Status</h4>
                            <div id="game-party-list" class="game-party-list">
                                <!-- Party members will be populated here -->
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <h4>Quick Actions</h4>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="initiateAction('combat')">‚öîÔ∏è Combat</button>
                                <button class="action-btn" onclick="initiateAction('explore')">üó∫Ô∏è Explore</button>
                                <button class="action-btn" onclick="initiateAction('rest')">üèïÔ∏è Rest</button>
                                <button class="action-btn" onclick="initiateAction('inventory')">üéí Inventory</button>
                            </div>
                        </div>
                        
                        <div class="game-state">
                            <h4>Current Status</h4>
                            <div id="game-status" class="status-info">
                                <p><strong>Location:</strong> <span id="current-location">Starting Region</span></p>
                                <p><strong>Time:</strong> <span id="current-time">Morning</span></p>
                                <p><strong>Weather:</strong> <span id="current-weather">Clear</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI DM Settings Modal -->
        <div id="ai-dm-settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ü§ñ AI Dungeon Master Settings</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="ai-engine-selection">
                        <h4>AI Engine</h4>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="aiEngine" value="templates" checked>
                                Template-Based (Free, Basic)
                            </label>
                            <label>
                                <input type="radio" name="aiEngine" value="openai">
                                OpenAI GPT (Premium, Dynamic)
                            </label>
                        </div>
                    </div>
                    
                    <div id="openai-settings" style="display: none;">
                        <div class="form-group">
                            <label for="openai-api-key">OpenAI API Key</label>
                            <input type="password" id="openai-api-key" placeholder="sk-...">
                            <small>Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="openai-model">Model</label>
                            <select id="openai-model">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast, Economical)</option>
                                <option value="gpt-4">GPT-4 (Best Quality)</option>
                                <option value="gpt-4-turbo-preview">GPT-4 Turbo (Fast, High Quality)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="ai-creativity">Creativity Level</label>
                            <input type="range" id="ai-creativity" min="0" max="100" value="70">
                            <span id="ai-creativity-display">70%</span>
                            <small>Higher = more creative/unpredictable responses</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="ai-response-length">Response Length</label>
                            <select id="ai-response-length">
                                <option value="brief">Brief (1-2 sentences)</option>
                                <option value="normal" selected>Normal (2-4 sentences)</option>
                                <option value="detailed">Detailed (4-6 sentences)</option>
                                <option value="verbose">Verbose (6+ sentences)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="ai-use-campaign-context" checked>
                                Use Campaign Context (scenario, party, history)
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="ai-use-reference-data" checked>
                                Use D&D Reference Data (monsters, rules, items)
                            </label>
                        </div>
                        
                        <button class="secondary-button" onclick="testOpenAIConnection()">Test Connection</button>
                        <div id="openai-test-result"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                    <button class="primary-button" onclick="saveAIDMSettings()">Save Settings</button>
                </div>
            </div>
        </div>
        
        <!-- Voice Settings Modal -->
        <div id="voice-settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üé§ Voice Settings</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="voice-engine-selection">
                        <h4>Voice Engine</h4>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="voiceEngine" value="browser" checked>
                                Browser TTS (Free, Basic Quality)
                            </label>
                            <label>
                                <input type="radio" name="voiceEngine" value="elevenlabs">
                                ElevenLabs (Premium, High Quality)
                            </label>
                        </div>
                    </div>
                    
                    <div id="elevenlabs-settings" class="elevenlabs-settings" style="display: none;">
                        <h4>ElevenLabs Configuration</h4>
                        <div class="form-group">
                            <label for="elevenlabs-api-key">API Key:</label>
                            <input type="password" id="elevenlabs-api-key" placeholder="Enter your ElevenLabs API key" 
                                   value="${localStorage.getItem('elevenlabs_api_key') || ''}">
                            <small>Your API key is stored locally and never sent to our servers</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="elevenlabs-voice-id">DM Voice:</label>
                            <select id="elevenlabs-voice-id">
                                <option value="">Loading voices...</option>
                            </select>
                            <button type="button" onclick="loadElevenLabsVoices()" class="secondary-button">Refresh Voices</button>
                        </div>
                        
                        <div class="form-group">
                            <label for="voice-stability">Stability (0-1):</label>
                            <input type="range" id="voice-stability" min="0" max="1" step="0.1" value="0.5">
                            <span id="stability-value">0.5</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="voice-clarity">Clarity & Similarity (0-1):</label>
                            <input type="range" id="voice-clarity" min="0" max="1" step="0.1" value="0.75">
                            <span id="clarity-value">0.75</span>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" onclick="testElevenLabsVoice()" class="primary-button">Test Voice</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                    <button class="primary-button" onclick="saveVoiceSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Simple button handlers that work immediately -->
    <script>
        // Simple screen switching function that works without modules
        function switchScreen(screenName) {
            console.log('Switching to screen:', screenName);
            
            // Hide all screens
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });
            
            // Show the target screen
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.style.display = 'block';
                targetScreen.classList.add('active');
                console.log('Screen shown:', screenName);
            } else {
                console.error('Screen not found:', screenName);
            }
        }
        
        // Add click handlers when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up button handlers...');
            
            // Create New Campaign button
            const createBtn = document.getElementById('create-campaign-btn');
            if (createBtn) {
                createBtn.onclick = function() {
                    console.log('Create Campaign clicked');
                    switchScreen('campaignCreation');
                };
                console.log('Create Campaign button handler attached');
            }
            
            // Continue Campaign button
            const continueBtn = document.getElementById('continue-campaign-btn');
            if (continueBtn) {
                continueBtn.onclick = function() {
                    console.log('Continue Campaign clicked');
                    showCampaignList();
                };
                console.log('Continue Campaign button handler attached');
            }
            
            // Load from GitHub button
            const githubBtn = document.getElementById('load-github-btn');
            if (githubBtn) {
                githubBtn.onclick = function() {
                    console.log('Load from GitHub clicked');
                    alert('GitHub integration will be available soon!');
                };
                console.log('GitHub button handler attached');
            }
            
            // World Browser button
            const worldBtn = document.getElementById('world-browser-btn');
            if (worldBtn) {
                worldBtn.onclick = function() {
                    console.log('World Browser clicked');
                    switchScreen('worldBrowser');
                };
                console.log('World Browser button handler attached');
            }
            
            // Settings button
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.onclick = function() {
                    console.log('Settings clicked');
                    switchScreen('settings');
                };
                console.log('Settings button handler attached');
            }
            
            console.log('All button handlers set up');
        });
        
        // Scenario selection function
        function selectScenario(scenarioId) {
            console.log('Selecting scenario:', scenarioId);
            
            // Remove selected class from all scenarios
            const scenarios = document.querySelectorAll('.scenario-option');
            scenarios.forEach(scenario => {
                scenario.classList.remove('selected');
            });
            
            // Add selected class to clicked scenario
            const selectedScenario = document.querySelector(`[data-scenario="${scenarioId}"]`);
            if (selectedScenario) {
                selectedScenario.classList.add('selected');
                
                // Update hidden input value
                const hiddenInput = document.getElementById('selected-scenario');
                if (hiddenInput) {
                    hiddenInput.value = scenarioId;
                }
                
                console.log('Scenario selected:', scenarioId);
            }
        }
        
        // Campaign creation function
        function createCampaign(event) {
            event.preventDefault(); // Prevent form submission
            console.log('Creating campaign...');
            
            // Get form data
            const form = document.getElementById('campaign-creation-form');
            const formData = new FormData(form);
            const campaignData = {
                id: 'campaign_' + Date.now(),
                name: formData.get('campaignName'),
                worldSeed: formData.get('worldSeed'),
                moralComplexity: formData.get('moralComplexity'),
                startingRegion: formData.get('startingRegion'),
                startingScenario: formData.get('startingScenario'),
                createdDate: new Date().toISOString(),
                lastPlayed: new Date().toISOString(),
                characters: [],
                gameState: {
                    currentLocation: 'Starting Region',
                    storyProgress: 0,
                    completedQuests: [],
                    activeQuests: []
                }
            };
            
            console.log('Campaign data:', campaignData);
            
            // Save campaign to localStorage
            saveCampaign(campaignData);
            
            // Set as current campaign
            window.currentCampaign = campaignData;
            
            // Show character setup screen
            switchScreen('characterSetup');
            
            // Show success message
            alert('Campaign "' + campaignData.name + '" created successfully!');
        }
        
        // Save campaign to localStorage
        function saveCampaign(campaignData) {
            try {
                // Get existing campaigns
                let campaigns = JSON.parse(localStorage.getItem('dnd_campaigns')) || [];
                
                // Find existing campaign or add new one
                const existingIndex = campaigns.findIndex(c => c.id === campaignData.id);
                if (existingIndex >= 0) {
                    campaigns[existingIndex] = campaignData;
                    console.log('Updated existing campaign:', campaignData.name);
                } else {
                    campaigns.push(campaignData);
                    console.log('Added new campaign:', campaignData.name);
                }
                
                // Save to localStorage
                localStorage.setItem('dnd_campaigns', JSON.stringify(campaigns));
                console.log('Campaign saved to localStorage');
                
                return true;
            } catch (error) {
                console.error('Error saving campaign:', error);
                return false;
            }
        }
        
        // Load campaigns from localStorage
        function loadCampaigns() {
            try {
                return JSON.parse(localStorage.getItem('dnd_campaigns')) || [];
            } catch (error) {
                console.error('Error loading campaigns:', error);
                return [];
            }
        }
        
        // Save current campaign data (characters, progress, etc.)
        function saveCurrentCampaignData() {
            if (window.currentCampaign) {
                // Update campaign with current party data
                if (window.partyCharacters) {
                    window.currentCampaign.characters = window.partyCharacters;
                }
                
                // Update last played timestamp
                window.currentCampaign.lastPlayed = new Date().toISOString();
                
                // Save to localStorage
                const success = saveCampaign(window.currentCampaign);
                if (success) {
                    console.log('Current campaign data saved');
                    return true;
                } else {
                    console.error('Failed to save current campaign data');
                    return false;
                }
            }
            return false;
        }
        
        // Prompt to save before navigating away
        function promptToSave(targetScreen) {
            if (window.currentCampaign && targetScreen === 'mainMenu') {
                const shouldSave = confirm('Do you want to save your current campaign progress before returning to the main menu?');
                if (shouldSave) {
                    const saved = saveCurrentCampaignData();
                    if (saved) {
                        alert('Campaign saved successfully!');
                    } else {
                        alert('Failed to save campaign. Please try again.');
                        return; // Don't navigate if save failed
                    }
                }
                
                // Clear current campaign when going to main menu
                window.currentCampaign = null;
                window.partyCharacters = [];
            }
            
            // Proceed with navigation
            switchScreen(targetScreen);
        }
        
        // Character parsing function
        function parseCharacterSheet() {
            const textarea = document.getElementById('character-import-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please paste character sheet data first!');
                return;
            }
            
            console.log('Parsing character sheet...');
            
            try {
                const character = parseCharacterData(text);
                console.log('Parsed character:', character);
                
                // Add character to party
                addCharacterToParty(character);
                
                // Close the modal
                document.getElementById('import-modal').style.display = 'none';
                
                // Clear the textarea
                textarea.value = '';
                
                alert('Character "' + character.name + '" imported successfully!');
                
            } catch (error) {
                console.error('Error parsing character:', error);
                alert('Error parsing character sheet. Please check the format.');
            }
        }
        
        // Parse the character data from the text format
        function parseCharacterData(text) {
            const lines = text.split('\n');
            const character = {
                // Basic info
                name: '',
                class: '',
                level: 1,
                species: '',
                background: '',
                alignment: '',
                
                // Ability scores
                abilities: {
                    strength: 10, dexterity: 10, constitution: 10,
                    intelligence: 10, wisdom: 10, charisma: 10
                },
                
                // Combat stats
                combat: {
                    armorClass: 10,
                    hitPoints: { current: 1, max: 1 },
                    initiative: 0,
                    speed: 30,
                    proficiencyBonus: 2
                },
                
                // Skills and saves
                savingThrows: {},
                skills: {},
                
                // Equipment and weapons
                weapons: [],
                equipment: {},
                
                // Features and traits
                features: [],
                
                // Other data
                proficiencies: {
                    armor: '', weapons: '', tools: '', languages: ''
                },
                personality: {
                    traits: '', ideals: '', bonds: '', flaws: ''
                },
                currency: {
                    cp: 0, sp: 0, ep: 0, gp: 0, pp: 0
                }
            };
            
            let currentSection = '';
            
            for (let line of lines) {
                line = line.trim();
                
                // Skip comments and empty lines
                if (line.startsWith('#') || !line) continue;
                
                // Check for section headers
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.slice(1, -1);
                    continue;
                }
                
                // Parse key=value pairs
                if (line.includes('=')) {
                    const [key, value] = line.split('=', 2);
                    const cleanKey = key.trim();
                    const cleanValue = value.trim();
                    
                    switch (currentSection) {
                        case 'CHARACTER_INFO':
                            if (cleanKey === 'name') character.name = cleanValue;
                            else if (cleanKey === 'class') character.class = cleanValue;
                            else if (cleanKey === 'level') character.level = parseInt(cleanValue);
                            else if (cleanKey === 'species') character.species = cleanValue;
                            else if (cleanKey === 'background') character.background = cleanValue;
                            else if (cleanKey === 'alignment') character.alignment = cleanValue;
                            break;
                            
                        case 'ABILITY_SCORES':
                            if (cleanKey in character.abilities) {
                                character.abilities[cleanKey] = parseInt(cleanValue);
                            }
                            break;
                            
                        case 'COMBAT_STATS':
                            if (cleanKey === 'armor_class') character.combat.armorClass = parseInt(cleanValue);
                            else if (cleanKey === 'hit_points_max') character.combat.hitPoints.max = parseInt(cleanValue);
                            else if (cleanKey === 'hit_points_current') character.combat.hitPoints.current = parseInt(cleanValue);
                            else if (cleanKey === 'initiative') character.combat.initiative = cleanValue;
                            else if (cleanKey === 'speed') character.combat.speed = parseInt(cleanValue);
                            else if (cleanKey === 'proficiency_bonus') character.combat.proficiencyBonus = cleanValue;
                            break;
                            
                        case 'SAVING_THROWS':
                            character.savingThrows[cleanKey] = cleanValue;
                            break;
                            
                        case 'SKILLS':
                            character.skills[cleanKey] = cleanValue;
                            break;
                            
                        case 'WEAPONS':
                            if (cleanKey.startsWith('weapon_')) {
                                const weaponData = cleanValue.split(',');
                                if (weaponData.length >= 3) {
                                    character.weapons.push({
                                        name: weaponData[0],
                                        attackBonus: weaponData[1],
                                        damage: weaponData[2],
                                        properties: weaponData[3] || ''
                                    });
                                }
                            }
                            break;
                            
                        case 'EQUIPMENT':
                            if (!cleanKey.includes('_qty') && !cleanKey.includes('total_') && !cleanKey.includes('encumbered') && !cleanKey.includes('max_carry')) {
                                const equipData = cleanValue.split(',');
                                character.equipment[cleanKey] = {
                                    quantity: parseInt(equipData[0]) || 1,
                                    weight: parseInt(equipData[1]) || 0
                                };
                            }
                            break;
                            
                        case 'PROFICIENCIES':
                            if (cleanKey === 'armor') character.proficiencies.armor = cleanValue;
                            else if (cleanKey === 'weapons') character.proficiencies.weapons = cleanValue;
                            else if (cleanKey === 'tools') character.proficiencies.tools = cleanValue;
                            else if (cleanKey === 'languages') character.proficiencies.languages = cleanValue;
                            break;
                            
                        case 'PERSONALITY':
                            if (cleanKey === 'personality_traits') character.personality.traits = cleanValue;
                            else if (cleanKey === 'ideals') character.personality.ideals = cleanValue;
                            else if (cleanKey === 'bonds') character.personality.bonds = cleanValue;
                            else if (cleanKey === 'flaws') character.personality.flaws = cleanValue;
                            break;
                            
                        case 'CURRENCY':
                            if (cleanKey === 'copper_pieces') character.currency.cp = parseInt(cleanValue);
                            else if (cleanKey === 'silver_pieces') character.currency.sp = parseInt(cleanValue);
                            else if (cleanKey === 'electrum_pieces') character.currency.ep = parseInt(cleanValue);
                            else if (cleanKey === 'gold_pieces') character.currency.gp = parseInt(cleanValue);
                            else if (cleanKey === 'platinum_pieces') character.currency.pp = parseInt(cleanValue);
                            break;
                            
                        case 'FEATURES_TRAITS':
                            if (cleanValue && !cleanValue.startsWith('#')) {
                                character.features.push({
                                    name: cleanKey.replace(/_/g, ' '),
                                    description: cleanValue
                                });
                            }
                            break;
                    }
                }
            }
            
            return character;
        }
        
        // Add character to the party display
        function addCharacterToParty(character) {
            const partyList = document.getElementById('party-list');
            const emptyParty = partyList.querySelector('.empty-party');
            
            // Remove empty party message
            if (emptyParty) {
                emptyParty.remove();
            }
            
            // Remove existing "Add Another Character" button if it exists
            const existingAddBtn = partyList.querySelector('.add-another-character');
            if (existingAddBtn) {
                existingAddBtn.remove();
            }
            
            // Create character card
            const characterCard = document.createElement('div');
            characterCard.className = 'character-card';
            characterCard.innerHTML = `
                <div class="character-info">
                    <h4>${character.name}</h4>
                    <p>Level ${character.level} ${character.species} ${character.class}</p>
                    <p>AC: ${character.combat.armorClass} | HP: ${character.combat.hitPoints.current}/${character.combat.hitPoints.max}</p>
                </div>
                <div class="character-actions">
                    <button class="secondary-button" onclick="editCharacter('${character.name}')">Edit</button>
                    <button class="secondary-button" onclick="viewCharacterSheet('${character.name}')">View Sheet</button>
                    <button class="danger-button" onclick="removeCharacter('${character.name}')">Remove</button>
                </div>
            `;
            
            partyList.appendChild(characterCard);
            
            // Add "Add Another Character" button after all characters
            const addAnotherBtn = document.createElement('div');
            addAnotherBtn.className = 'add-another-character';
            addAnotherBtn.innerHTML = `
                <button class="secondary-button" onclick="document.getElementById('import-modal').style.display='flex'">
                    <span class="button-icon">‚ûï</span>
                    Add Another Character
                </button>
            `;
            partyList.appendChild(addAnotherBtn);
            
            // Show character actions section
            document.getElementById('character-actions').style.display = 'block';
            
            // Store character data (in a real app this would go to a database)
            if (!window.partyCharacters) window.partyCharacters = [];
            window.partyCharacters.push(character);
        }
        
        // Remove character from party
        function removeCharacter(characterName) {
            if (confirm(`Remove ${characterName} from the party?`)) {
                // Remove from party array
                if (window.partyCharacters) {
                    window.partyCharacters = window.partyCharacters.filter(c => c.name !== characterName);
                }
                
                // Remove from DOM
                const partyList = document.getElementById('party-list');
                const characterCards = partyList.querySelectorAll('.character-card');
                
                characterCards.forEach(card => {
                    const nameElement = card.querySelector('h4');
                    if (nameElement && nameElement.textContent === characterName) {
                        card.remove();
                    }
                });
                
                // If no characters left, show empty party message
                if (!window.partyCharacters || window.partyCharacters.length === 0) {
                    const addAnotherBtn = partyList.querySelector('.add-another-character');
                    if (addAnotherBtn) {
                        addAnotherBtn.remove();
                    }
                    
                    const emptyParty = document.createElement('div');
                    emptyParty.className = 'empty-party';
                    emptyParty.innerHTML = `
                        <p>No characters in party. Import or create characters to get started.</p>
                        <button class="primary-button" onclick="document.getElementById('import-modal').style.display='flex'">
                            <span class="button-icon">üë•</span>
                            Add First Character
                        </button>
                    `;
                    partyList.appendChild(emptyParty);
                    
                    // Hide character actions
                    document.getElementById('character-actions').style.display = 'none';
                }
            }
        }
        
        // View character sheet function
        function viewCharacterSheet(characterName) {
            const character = window.partyCharacters?.find(c => c.name === characterName);
            if (!character) {
                alert('Character not found!');
                return;
            }
            
            // Populate character sheet fields
            populateCharacterSheet(character);
            
            // Switch to character sheet screen
            switchScreen('characterSheet');
        }
        
        // Populate character sheet with character data
        function populateCharacterSheet(character) {
            // Basic info
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-class-level').textContent = `Level ${character.level} ${character.class}`;
            document.getElementById('character-race').textContent = character.species;
            
            // Combat stats
            document.getElementById('ac-value').textContent = character.combat.armorClass;
            document.getElementById('max-hp').textContent = character.combat.hitPoints.max;
            document.getElementById('current-hp').value = character.combat.hitPoints.current;
            document.getElementById('speed-value').textContent = character.combat.speed + ' ft';
            document.getElementById('prof-bonus').textContent = character.combat.proficiencyBonus;
            
            // Ability scores
            for (const [ability, score] of Object.entries(character.abilities)) {
                const modifier = Math.floor((score - 10) / 2);
                const modifierStr = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                
                document.getElementById(`${ability.substring(0, 3)}-score`).textContent = score;
                document.getElementById(`${ability.substring(0, 3)}-mod`).textContent = modifierStr;
            }
            
            // Add character to switcher dropdown
            const switcher = document.getElementById('character-switcher');
            if (switcher && !Array.from(switcher.options).some(opt => opt.value === character.name)) {
                const option = document.createElement('option');
                option.value = character.name;
                option.textContent = character.name;
                option.selected = true;
                switcher.appendChild(option);
            }
            
            console.log('Character sheet populated for:', character.name);
        }
        
        // Edit character function (placeholder)
        function editCharacter(characterName) {
            alert('Edit character functionality will be available soon!');
        }
        
        // Load and display saved campaigns
        function showCampaignList() {
            const campaigns = loadCampaigns();
            const contentDiv = document.getElementById('campaign-list-content');
            
            if (campaigns.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No saved campaigns found.</p>
                        <button class="primary-button" onclick="switchScreen('campaignCreation')">Create New Campaign</button>
                    </div>
                `;
            } else {
                let campaignsHTML = '<div class="campaigns-grid">';
                
                campaigns.forEach(campaign => {
                    const lastPlayed = new Date(campaign.lastPlayed).toLocaleDateString();
                    const characterCount = campaign.characters ? campaign.characters.length : 0;
                    
                    campaignsHTML += `
                        <div class="campaign-card">
                            <div class="campaign-info">
                                <h3>${campaign.name}</h3>
                                <p><strong>Region:</strong> ${campaign.startingRegion}</p>
                                <p><strong>Characters:</strong> ${characterCount}</p>
                                <p><strong>Last Played:</strong> ${lastPlayed}</p>
                            </div>
                            <div class="campaign-actions">
                                <button class="primary-button" onclick="loadCampaign('${campaign.id}')">Continue</button>
                                <button class="secondary-button" onclick="deleteCampaign('${campaign.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                campaignsHTML += '</div>';
                campaignsHTML += `
                    <div class="campaign-list-actions">
                        <button class="primary-button" onclick="switchScreen('campaignCreation')">Create New Campaign</button>
                    </div>
                `;
                
                contentDiv.innerHTML = campaignsHTML;
            }
            
            switchScreen('campaignList');
        }
        
        // Load a specific campaign
        function loadCampaign(campaignId) {
            const campaigns = loadCampaigns();
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (campaign) {
                console.log('Loading campaign:', campaign.name);
                
                // Set as current campaign
                window.currentCampaign = campaign;
                
                // Load characters into party
                if (campaign.characters && campaign.characters.length > 0) {
                    window.partyCharacters = campaign.characters;
                    
                    // Go directly to game if characters exist
                    populateGameScreen();
                    switchScreen('game');
                } else {
                    // Go to character setup if no characters
                    switchScreen('characterSetup');
                }
                
                alert('Loaded campaign: ' + campaign.name);
            } else {
                alert('Campaign not found!');
            }
        }
        
        // Delete a campaign
        function deleteCampaign(campaignId) {
            if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                let campaigns = loadCampaigns();
                campaigns = campaigns.filter(c => c.id !== campaignId);
                localStorage.setItem('dnd_campaigns', JSON.stringify(campaigns));
                
                // Refresh the campaign list
                showCampaignList();
                
                alert('Campaign deleted successfully.');
            }
        }
        
        // Continue to game function
        function continueToGame() {
            console.log('Continuing to game...');
            
            // Save current party to campaign
            if (window.currentCampaign) {
                saveCurrentCampaignData();
            }
            
            // Populate game screen with party data
            populateGameScreen();
            
            // Switch to game screen
            switchScreen('game');
            
            // Start the adventure with opening narration
            setTimeout(() => {
                startAdventureNarration();
            }, 500);
        }
        
        // Populate game screen with party data
        function populateGameScreen() {
            const gamePartyList = document.getElementById('game-party-list');
            if (gamePartyList && window.partyCharacters && window.partyCharacters.length > 0) {
                gamePartyList.innerHTML = '';
                window.partyCharacters.forEach(character => {
                    const partyMember = document.createElement('div');
                    partyMember.className = 'party-member';
                    partyMember.innerHTML = `
                        <div class="member-info">
                            <strong>${character.name}</strong>
                            <span>Level ${character.level} ${character.species} ${character.class}</span>
                        </div>
                        <div class="member-stats">
                            <span>AC: ${character.combat.armorClass}</span>
                            <span>HP: ${character.combat.hitPoints.current}/${character.combat.hitPoints.max}</span>
                        </div>
                    `;
                    gamePartyList.appendChild(partyMember);
                });
            }
            
            // Initialize the adventure conversation when game screen loads
            setTimeout(() => {
                initializeVoiceSystem();
                initializeAdventure();
            }, 500);
        }
        
        // Add event listeners when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up additional button handlers...');
            
            // Parse character button
            const parseBtn = document.getElementById('parse-character-btn');
            if (parseBtn) {
                parseBtn.onclick = parseCharacterSheet;
                console.log('Parse character button handler attached');
            }
            
            // Continue to game button
            const continueBtn = document.getElementById('continue-to-game-btn');
            if (continueBtn) {
                continueBtn.onclick = continueToGame;
                console.log('Continue to game button handler attached');
            }
            
            // Import character button (opens modal)
            const importBtn = document.getElementById('import-character-btn');
            if (importBtn) {
                importBtn.onclick = function() {
                    document.getElementById('import-modal').style.display = 'flex';
                };
                console.log('Import character button handler attached');
            }
            
            // Test GitHub connection button
            const testGitHubBtn = document.getElementById('test-github-connection');
            if (testGitHubBtn) {
                testGitHubBtn.onclick = function() {
                    alert('GitHub connection test - feature coming soon!');
                };
                console.log('Test GitHub connection button handler attached');
            }
            
            // Save character button
            const saveCharBtn = document.getElementById('save-character-btn');
            if (saveCharBtn) {
                saveCharBtn.onclick = function() {
                    alert('Character saved successfully!');
                };
                console.log('Save character button handler attached');
            }
            
            // World browser buttons
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) {
                searchBtn.onclick = function() {
                    const searchInput = document.getElementById('world-search');
                    alert('Searching for: ' + searchInput.value);
                };
                console.log('World search button handler attached');
            }
            
            // Add entity buttons (placeholder functionality)
            const addButtons = [
                'add-npc-btn', 'add-location-btn', 'add-faction-btn', 'add-event-btn'
            ];
            
            addButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.onclick = function() {
                        alert('Add ' + btnId.replace('add-', '').replace('-btn', '') + ' feature coming soon!');
                    };
                    console.log(`${btnId} handler attached`);
                }
            });
            
            console.log('All additional button handlers set up');
        });
        
        // ===============================
        // VOICE SYSTEM VARIABLES
        // ===============================
        
        let voiceRecognition = null;
        let voiceSynthesis = window.speechSynthesis;
        let isDMVoiceEnabled = true;
        let isListening = false;
        let dmVoice = null;
        
        // ElevenLabs configuration
        let elevenLabsConfig = {
            apiKey: localStorage.getItem('elevenlabs_api_key') || '',
            voiceId: localStorage.getItem('elevenlabs_voice_id') || '',
            stability: parseFloat(localStorage.getItem('elevenlabs_stability')) || 0.5,
            clarity: parseFloat(localStorage.getItem('elevenlabs_clarity')) || 0.75,
            enabled: localStorage.getItem('voice_engine') === 'elevenlabs'
        };
        
        // Initialize voice system
        function initializeVoiceSystem() {
            console.log('Initializing voice system...');
            
            // Check if speech recognition is supported
            if ('speechRecognition' in window || 'webkitSpeechRecognition' in window) {
                voiceRecognition = new (window.speechRecognition || window.webkitSpeechRecognition)();
                setupSpeechRecognition();
            } else {
                console.warn('Speech recognition not supported in this browser');
                document.getElementById('start-listening-btn').disabled = true;
                document.getElementById('voice-status-text').textContent = 'Voice not supported';
            }
            
            // Setup speech synthesis voice for DM
            if (voiceSynthesis.getVoices().length === 0) {
                voiceSynthesis.addEventListener('voiceschanged', setupDMVoice);
            } else {
                setupDMVoice();
            }
        }
        
        // Setup speech recognition
        function setupSpeechRecognition() {
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = true;
            voiceRecognition.lang = 'en-US';
            
            voiceRecognition.onstart = function() {
                console.log('Voice recognition started');
                isListening = true;
                updateVoiceStatus('Listening... speak now', 'listening');
                document.getElementById('start-listening-btn').style.display = 'none';
                document.getElementById('stop-listening-btn').style.display = 'inline-block';
            };
            
            voiceRecognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Update status with interim results
                if (interimTranscript) {
                    updateVoiceStatus('Hearing: "' + interimTranscript + '"', 'processing');
                }
                
                // Process final result
                if (finalTranscript) {
                    console.log('Voice recognition result:', finalTranscript);
                    processVoiceInput(finalTranscript);
                }
            };
            
            voiceRecognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);
                updateVoiceStatus('Voice error: ' + event.error, 'error');
                resetVoiceControls();
            };
            
            voiceRecognition.onend = function() {
                console.log('Voice recognition ended');
                isListening = false;
                resetVoiceControls();
            };
        }
        
        // Setup DM voice
        function setupDMVoice() {
            const voices = voiceSynthesis.getVoices();
            
            // Prefer a good narrative voice (look for specific voices)
            dmVoice = voices.find(voice => 
                voice.name.includes('Natural') || 
                voice.name.includes('Neural') ||
                voice.name.includes('Premium') ||
                (voice.lang.startsWith('en') && voice.name.includes('Male'))
            ) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
            
            console.log('DM Voice selected:', dmVoice?.name);
        }
        
        // Voice control functions
        function startListening() {
            if (voiceRecognition && !isListening) {
                try {
                    voiceRecognition.start();
                } catch (error) {
                    console.error('Error starting voice recognition:', error);
                    updateVoiceStatus('Error starting microphone', 'error');
                }
            }
        }
        
        function stopListening() {
            if (voiceRecognition && isListening) {
                voiceRecognition.stop();
            }
        }
        
        function toggleDMVoice() {
            isDMVoiceEnabled = !isDMVoiceEnabled;
            const toggle = document.getElementById('dm-voice-toggle');
            toggle.textContent = isDMVoiceEnabled ? 'üîä DM Voice: ON' : 'üîá DM Voice: OFF';
            
            if (!isDMVoiceEnabled) {
                voiceSynthesis.cancel(); // Stop any current speech
            }
        }
        
        function updateVoiceStatus(text, status = 'ready') {
            const statusText = document.getElementById('voice-status-text');
            const indicator = document.getElementById('voice-status-indicator');
            
            statusText.textContent = text;
            indicator.className = `voice-indicator ${status}`;
        }
        
        function resetVoiceControls() {
            document.getElementById('start-listening-btn').style.display = 'inline-block';
            document.getElementById('stop-listening-btn').style.display = 'none';
            updateVoiceStatus('Ready to listen', 'ready');
        }
        
        // Process voice input from player
        function processVoiceInput(transcript) {
            console.log('Processing voice input:', transcript);
            
            // Add player message to conversation
            const playerMessage = `
                <div class="player-message voice-message">
                    <div class="message-header">
                        <strong>üé≠ ${getActiveCharacterName()}</strong>
                        <span class="voice-indicator-small">üé§</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p>"${transcript}"</p>
                    </div>
                </div>
            `;
            
            appendToConversation(playerMessage);
            updateVoiceStatus('Processing your action...', 'processing');
            
            // Generate AI DM response
            setTimeout(() => {
                generateVoiceDMResponse(transcript);
            }, 1000);
        }
        
        // Speak text using DM voice
        function speakAsDM(text) {
            if (!isDMVoiceEnabled) return;
            
            // Use ElevenLabs if configured, otherwise fall back to browser TTS
            if (elevenLabsConfig.enabled && elevenLabsConfig.apiKey && elevenLabsConfig.voiceId) {
                generateElevenLabsSpeech(text);
            } else {
                speakAsDMBrowser(text);
            }
        }
        
        // ===============================
        // ELEVENLABS INTEGRATION
        // ===============================
        
        // Open voice settings modal
        function openVoiceSettings() {
            const modal = document.getElementById('voice-settings-modal');
            
            // Load current settings
            const engineRadios = document.querySelectorAll('input[name="voiceEngine"]');
            engineRadios.forEach(radio => {
                radio.checked = radio.value === (elevenLabsConfig.enabled ? 'elevenlabs' : 'browser');
            });
            
            // Update UI
            toggleElevenLabsSettings();
            updateSliderDisplays();
            
            // Show modal
            modal.style.display = 'flex';
            
            // Load voices if ElevenLabs is selected and API key exists
            if (elevenLabsConfig.enabled && elevenLabsConfig.apiKey) {
                loadElevenLabsVoices();
            }
        }
        
        // Toggle ElevenLabs settings visibility
        function toggleElevenLabsSettings() {
            const elevenLabsRadio = document.querySelector('input[value="elevenlabs"]');
            const elevenLabsSettings = document.getElementById('elevenlabs-settings');
            
            if (elevenLabsRadio.checked) {
                elevenLabsSettings.style.display = 'block';
            } else {
                elevenLabsSettings.style.display = 'none';
            }
        }
        
        // Update slider display values
        function updateSliderDisplays() {
            const stabilitySlider = document.getElementById('voice-stability');
            const claritySlider = document.getElementById('voice-clarity');
            
            stabilitySlider.value = elevenLabsConfig.stability;
            claritySlider.value = elevenLabsConfig.clarity;
            
            document.getElementById('stability-value').textContent = elevenLabsConfig.stability;
            document.getElementById('clarity-value').textContent = elevenLabsConfig.clarity;
            
            // Add event listeners for real-time updates
            stabilitySlider.oninput = function() {
                document.getElementById('stability-value').textContent = this.value;
            };
            claritySlider.oninput = function() {
                document.getElementById('clarity-value').textContent = this.value;
            };
        }
        
        // Load available ElevenLabs voices
        async function loadElevenLabsVoices() {
            const apiKey = document.getElementById('elevenlabs-api-key').value || elevenLabsConfig.apiKey;
            const voiceSelect = document.getElementById('elevenlabs-voice-id');
            
            if (!apiKey) {
                voiceSelect.innerHTML = '<option value="">Enter API key first</option>';
                return;
            }
            
            try {
                voiceSelect.innerHTML = '<option value="">Loading voices...</option>';
                
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                voiceSelect.innerHTML = '<option value="">Select a voice...</option>';
                
                data.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id;
                    option.textContent = `${voice.name} (${voice.category || 'Custom'})`;
                    if (voice.voice_id === elevenLabsConfig.voiceId) {
                        option.selected = true;
                    }
                    voiceSelect.appendChild(option);
                });
                
                console.log('Loaded', data.voices.length, 'ElevenLabs voices');
                
            } catch (error) {
                console.error('Error loading ElevenLabs voices:', error);
                voiceSelect.innerHTML = '<option value="">Error loading voices</option>';
                alert('Error loading voices. Please check your API key.');
            }
        }
        
        // Test ElevenLabs voice
        async function testElevenLabsVoice() {
            const apiKey = document.getElementById('elevenlabs-api-key').value;
            const voiceId = document.getElementById('elevenlabs-voice-id').value;
            
            if (!apiKey || !voiceId) {
                alert('Please enter API key and select a voice first.');
                return;
            }
            
            const testText = "Greetings, brave adventurers! I am your Dungeon Master, ready to guide you through epic tales of magic and mystery.";
            
            try {
                await generateElevenLabsSpeech(testText, apiKey, voiceId);
            } catch (error) {
                console.error('Error testing voice:', error);
                alert('Error testing voice: ' + error.message);
            }
        }
        
        // Generate speech using ElevenLabs API
        async function generateElevenLabsSpeech(text, apiKey = null, voiceId = null) {
            const key = apiKey || elevenLabsConfig.apiKey;
            const voice = voiceId || elevenLabsConfig.voiceId;
            
            if (!key || !voice) {
                console.warn('ElevenLabs not configured, falling back to browser TTS');
                speakAsDMBrowser(text);
                return;
            }
            
            try {
                updateVoiceStatus('Generating AI voice...', 'processing');
                
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voice}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': key
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: elevenLabsConfig.stability,
                            similarity_boost: elevenLabsConfig.clarity,
                            style: 0.0,
                            use_speaker_boost: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`ElevenLabs API Error: ${response.status}`);
                }
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                audio.onplay = () => {
                    updateVoiceStatus('DM is speaking...', 'speaking');
                };
                
                audio.onended = () => {
                    updateVoiceStatus('Ready to listen', 'ready');
                    URL.revokeObjectURL(audioUrl);
                };
                
                audio.onerror = (error) => {
                    console.error('Audio playback error:', error);
                    updateVoiceStatus('Audio error', 'error');
                    URL.revokeObjectURL(audioUrl);
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('ElevenLabs TTS Error:', error);
                updateVoiceStatus('Voice error, using fallback', 'error');
                
                // Fallback to browser TTS
                speakAsDMBrowser(text);
            }
        }
        
        // Browser TTS fallback (rename existing function)
        function speakAsDMBrowser(text) {
            if (!voiceSynthesis) return;
            
            voiceSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (dmVoice) {
                utterance.voice = dmVoice;
            }
            
            utterance.rate = 0.85;
            utterance.pitch = 0.8;
            utterance.volume = 0.8;
            
            utterance.onstart = () => updateVoiceStatus('DM is speaking...', 'speaking');
            utterance.onend = () => updateVoiceStatus('Ready to listen', 'ready');
            utterance.onerror = () => updateVoiceStatus('Ready to listen', 'ready');
            
            voiceSynthesis.speak(utterance);
        }
        
        // Save voice settings
        function saveVoiceSettings() {
            // Get selected engine
            const selectedEngine = document.querySelector('input[name="voiceEngine"]:checked').value;
            
            // Save to config and localStorage
            elevenLabsConfig.enabled = selectedEngine === 'elevenlabs';
            localStorage.setItem('voice_engine', selectedEngine);
            
            if (elevenLabsConfig.enabled) {
                // Save ElevenLabs settings
                elevenLabsConfig.apiKey = document.getElementById('elevenlabs-api-key').value;
                elevenLabsConfig.voiceId = document.getElementById('elevenlabs-voice-id').value;
                elevenLabsConfig.stability = parseFloat(document.getElementById('voice-stability').value);
                elevenLabsConfig.clarity = parseFloat(document.getElementById('voice-clarity').value);
                
                localStorage.setItem('elevenlabs_api_key', elevenLabsConfig.apiKey);
                localStorage.setItem('elevenlabs_voice_id', elevenLabsConfig.voiceId);
                localStorage.setItem('elevenlabs_stability', elevenLabsConfig.stability);
                localStorage.setItem('elevenlabs_clarity', elevenLabsConfig.clarity);
            }
            
            // Close modal
            document.getElementById('voice-settings-modal').style.display = 'none';
            
            // Update voice toggle display
            const toggle = document.getElementById('dm-voice-toggle');
            toggle.innerHTML = elevenLabsConfig.enabled 
                ? 'üîä DM Voice: ElevenLabs' 
                : 'üîä DM Voice: Browser';
            
            alert('Voice settings saved!');
        }
        
        // Add event listeners for voice engine radio buttons
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('input[name="voiceEngine"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', toggleElevenLabsSettings);
            });
        });
        
        // ===============================
        // AI DM CONVERSATION SYSTEM
        // ===============================
        
        // Initialize conversation when game starts
        function initializeAdventure() {
            console.log('Initializing adventure...');
            
            // Clear any existing conversation
            const history = document.getElementById('conversation-history');
            if (history) {
                history.innerHTML = '';
            }
            
            // Start with the initial story beat
            startInitialStory();
        }
        
        // Get scenario-specific opening based on selected scenario
        function getScenarioOpening(scenario) {
            const scenarioOpenings = {
                mysterious_caravan: {
                    setting: "at the last known location of a missing merchant caravan",
                    description: "Wagon tracks lead off the main road into dense woods, and scattered coins glint in the mud. The silence is unsettling.",
                    hook: "You must discover what happened to the caravan and its valuable cargo."
                },
                goblin_raids: {
                    setting: "on the outskirts of Millhaven village",
                    description: "Smoke rises from burned farms, and frightened villagers huddle behind hastily built barricades. Goblin war cries echo in the distance.",
                    hook: "The villagers desperately need your help to drive back the goblin raiders."
                },
                ancient_ruins: {
                    setting: "before the entrance to long-forgotten ruins",
                    description: "Ancient stone archways covered in mysterious runes loom before you. Strange magical energies pulse from within the depths.",
                    hook: "Legend speaks of powerful artifacts hidden within these dangerous ruins."
                },
                political_intrigue: {
                    setting: "in the grand halls of the royal palace",
                    description: "Nobles in fine clothing whisper in shadowy corners, their words dripping with hidden meanings. Trust is a luxury you cannot afford.",
                    hook: "You must navigate the treacherous waters of court politics to uncover a conspiracy."
                }
            };
            
            return scenarioOpenings[scenario] || scenarioOpenings.mysterious_caravan;
        }
        
        // Start the initial story
        function startInitialStory() {
            const campaign = window.currentCampaign;
            const characters = window.partyCharacters || [];
            const scenarioInfo = getScenarioOpening(campaign?.startingScenario || 'mysterious_caravan');
            
            // Create spoken version (cleaner for voice)
            const spokenIntro = `Welcome, brave adventurers, to ${campaign?.name || 'your epic adventure'}! 
                You find yourselves in the ${campaign?.startingRegion || 'Sword Coast'}, ${scenarioInfo.setting}. 
                ${scenarioInfo.description} 
                ${characters.length > 0 ? `Your party consists of ${characters.map(c => `${c.name}, a level ${c.level} ${c.species} ${c.class}`).join(', ')}.` : 'Your character stands ready to begin this journey.'}
                ${scenarioInfo.hook} What do you choose to do?`;
            
            let initialStory = `
                <div class="dm-message voice-message">
                    <div class="message-header">
                        <strong>üé≠ Dungeon Master</strong>
                        <span class="voice-indicator-small">üîä</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p>Welcome, brave adventurers, to <strong>${campaign?.name || 'your epic adventure'}</strong>!</p>
                        
                        <p>You find yourselves in the <strong>${campaign?.startingRegion || 'Sword Coast'}</strong>, ${scenarioInfo.setting}.</p>
                        
                        <p>${scenarioInfo.description}</p>
                        
                        ${characters.length > 0 ? `<p>Your party consists of:</p><ul>${characters.map(c => `<li><strong>${c.name}</strong> - Level ${c.level} ${c.species} ${c.class}</li>`).join('')}</ul>` : '<p>Your character stands ready to begin this journey.</p>'}
                        
                        <p><strong>${scenarioInfo.hook}</strong></p>
                        
                        <p class="dm-prompt"><em>What do you choose to do?</em></p>
                    </div>
                </div>
            `;
            
            appendToConversation(initialStory);
            
            // Speak the introduction
            setTimeout(() => {
                speakAsDM(spokenIntro);
            }, 1000);
            
            // Update game status
            updateGameStatus(campaign?.startingRegion || 'Ancient Forest', 'Morning', 'Clear skies');
        }
        
        // Start a new story beat
        function startNewStoryBeat() {
            const newScenePrompts = [
                "A new challenge presents itself...",
                "The adventure takes an unexpected turn...",
                "Something stirs in the shadows...",
                "A distant sound catches your attention...",
                "The path ahead reveals new possibilities..."
            ];
            
            const randomPrompt = newScenePrompts[Math.floor(Math.random() * newScenePrompts.length)];
            
            const newScene = `
                <div class="dm-message">
                    <div class="message-header">
                        <strong>üé≠ Dungeon Master</strong>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p><em>${randomPrompt}</em></p>
                        <p class="dm-prompt">What would you like to do?</p>
                    </div>
                </div>
            `;
            
            appendToConversation(newScene);
        }
        
        // Send player action
        function sendPlayerAction() {
            const input = document.getElementById('player-input');
            const action = input.value.trim();
            
            if (!action) {
                alert('Please enter an action first!');
                return;
            }
            
            // Add player message to conversation
            const playerMessage = `
                <div class="player-message">
                    <div class="message-header">
                        <strong>üé≠ ${getActiveCharacterName()}</strong>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p>${action}</p>
                    </div>
                </div>
            `;
            
            appendToConversation(playerMessage);
            
            // Clear input
            input.value = '';
            
            // Generate AI DM response
            setTimeout(() => {
                generateDMResponse(action);
            }, 1000);
        }
        
        // Enhanced DM personality and game state
        const DM_STATE = {
            combatActive: false,
            currentLocation: null,
            npcsNearby: [],
            recentEvents: [],
            tensionLevel: 1,
            reference: null // Will hold the DM reference data
        };

        // Load DM reference data
        async function loadDMReference() {
            try {
                const response = await fetch('dm-reference.json');
                if (response.ok) {
                    DM_STATE.reference = await response.json();
                    console.log('DM Reference loaded successfully');
                    return true;
                } else {
                    console.warn('DM Reference file not found, using default responses');
                    return false;
                }
            } catch (error) {
                console.warn('Could not load DM reference:', error);
                return false;
            }
        }

        // Initialize DM reference on page load
        loadDMReference();

        // ===============================
        // OPENAI INTEGRATION
        // ===============================
        
        // OpenAI configuration
        const openAIConfig = {
            enabled: false,
            apiKey: localStorage.getItem('openai_api_key') || '',
            model: localStorage.getItem('openai_model') || 'gpt-3.5-turbo',
            creativity: parseInt(localStorage.getItem('openai_creativity') || '70'),
            responseLength: localStorage.getItem('openai_response_length') || 'normal',
            useCampaignContext: localStorage.getItem('openai_use_context') !== 'false',
            useReferenceData: localStorage.getItem('openai_use_reference') !== 'false'
        };

        // Open AI DM Settings modal
        function openAIDMSettings() {
            const modal = document.getElementById('ai-dm-settings-modal');
            
            // Load current settings
            const engineRadios = document.querySelectorAll('input[name="aiEngine"]');
            engineRadios.forEach(radio => {
                radio.checked = radio.value === (openAIConfig.enabled ? 'openai' : 'templates');
            });
            
            // Set form values
            document.getElementById('openai-api-key').value = openAIConfig.apiKey;
            document.getElementById('openai-model').value = openAIConfig.model;
            document.getElementById('ai-creativity').value = openAIConfig.creativity;
            document.getElementById('ai-creativity-display').textContent = openAIConfig.creativity + '%';
            document.getElementById('ai-response-length').value = openAIConfig.responseLength;
            document.getElementById('ai-use-campaign-context').checked = openAIConfig.useCampaignContext;
            document.getElementById('ai-use-reference-data').checked = openAIConfig.useReferenceData;
            
            // Toggle OpenAI settings visibility
            toggleOpenAISettings();
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Toggle OpenAI settings visibility
        function toggleOpenAISettings() {
            const openaiRadio = document.querySelector('input[value="openai"]:checked');
            const openaiSettings = document.getElementById('openai-settings');
            
            if (openaiRadio) {
                openaiSettings.style.display = 'block';
            } else {
                openaiSettings.style.display = 'none';
            }
        }

        // Save AI DM Settings
        function saveAIDMSettings() {
            const engineRadio = document.querySelector('input[name="aiEngine"]:checked');
            openAIConfig.enabled = engineRadio.value === 'openai';
            
            if (openAIConfig.enabled) {
                openAIConfig.apiKey = document.getElementById('openai-api-key').value;
                openAIConfig.model = document.getElementById('openai-model').value;
                openAIConfig.creativity = parseInt(document.getElementById('ai-creativity').value);
                openAIConfig.responseLength = document.getElementById('ai-response-length').value;
                openAIConfig.useCampaignContext = document.getElementById('ai-use-campaign-context').checked;
                openAIConfig.useReferenceData = document.getElementById('ai-use-reference-data').checked;
                
                // Save to localStorage
                localStorage.setItem('openai_enabled', 'true');
                localStorage.setItem('openai_api_key', openAIConfig.apiKey);
                localStorage.setItem('openai_model', openAIConfig.model);
                localStorage.setItem('openai_creativity', openAIConfig.creativity);
                localStorage.setItem('openai_response_length', openAIConfig.responseLength);
                localStorage.setItem('openai_use_context', openAIConfig.useCampaignContext);
                localStorage.setItem('openai_use_reference', openAIConfig.useReferenceData);
            } else {
                localStorage.setItem('openai_enabled', 'false');
            }
            
            // Close modal
            document.getElementById('ai-dm-settings-modal').style.display = 'none';
            
            alert('AI DM settings saved!');
        }

        // Test OpenAI connection
        async function testOpenAIConnection() {
            const apiKey = document.getElementById('openai-api-key').value;
            const resultDiv = document.getElementById('openai-test-result');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<span style="color: red;">Please enter an API key</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span style="color: yellow;">Testing connection...</span>';
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant. Respond with: "Connection successful!"'
                            },
                            {
                                role: 'user',
                                content: 'Test'
                            }
                        ],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = '<span style="color: green;">‚úÖ Connection successful! API key is valid.</span>';
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<span style="color: red;">‚ùå Error: ${error.error?.message || 'Invalid API key'}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">‚ùå Connection failed: ${error.message}</span>`;
            }
        }

        // Generate DM response using OpenAI
        async function generateOpenAIDMResponse(playerAction, context = {}) {
            if (!openAIConfig.apiKey) {
                console.warn('OpenAI API key not configured');
                return null;
            }
            
            // Build the system prompt
            let systemPrompt = `You are an expert Dungeons & Dragons 5e Dungeon Master. `;
            
            // Add campaign context if enabled
            if (openAIConfig.useCampaignContext && window.currentCampaign) {
                const campaign = window.currentCampaign;
                systemPrompt += `Campaign: ${campaign.scenario || 'fantasy'}. `;
                systemPrompt += `Tone: ${campaign.tone || 'balanced'}. `;
                systemPrompt += `Party: ${window.partyCharacters?.length || 1} adventurers. `;
            }
            
            // Add reference data context if enabled
            if (openAIConfig.useReferenceData && DM_STATE.reference) {
                systemPrompt += `You have access to D&D 5e rules, monsters, items, and encounters. `;
            }
            
            // Add story state
            if (STORY_STATE.plotThreads.length > 0) {
                systemPrompt += `Active plot: ${STORY_STATE.plotThreads[0].description}. `;
            }
            
            // Response length guidelines
            const lengthGuides = {
                brief: 'Keep responses to 1-2 sentences.',
                normal: 'Keep responses to 2-4 sentences.',
                detailed: 'Provide detailed responses of 4-6 sentences.',
                verbose: 'Give rich, descriptive responses of 6+ sentences.'
            };
            systemPrompt += lengthGuides[openAIConfig.responseLength];
            
            systemPrompt += ` Always end with "What do you do?" or a similar prompt. Be vivid, engaging, and true to D&D mechanics.`;
            
            // Build the user message
            let userMessage = `Player action: ${playerAction}`;
            
            // Add recent context if available
            if (STORY_STATE.storyBeats.length > 0) {
                const recentBeat = STORY_STATE.storyBeats[STORY_STATE.storyBeats.length - 1];
                userMessage += `\nRecent context: ${recentBeat.development}`;
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAIConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: openAIConfig.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: openAIConfig.creativity / 100, // Convert to 0-1 scale
                        max_tokens: 200
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const dmResponse = data.choices[0].message.content;
                    
                    return {
                        response: dmResponse,
                        voice: dmResponse,
                        source: 'openai'
                    };
                } else {
                    console.error('OpenAI API error:', await response.text());
                    return null;
                }
            } catch (error) {
                console.error('Failed to generate OpenAI response:', error);
                return null;
            }
        }

        // Get a random encounter based on location and difficulty
        function getRandomEncounter(location = 'forest', difficulty = 'easy') {
            if (!DM_STATE.reference?.encounter_tables) return null;
            
            const encounters = DM_STATE.reference.encounter_tables[location]?.[difficulty];
            if (!encounters) return null;
            
            return encounters[Math.floor(Math.random() * encounters.length)];
        }

        // Generate a random NPC with personality
        function generateNPC() {
            if (!DM_STATE.reference?.npc_generation) return null;
            
            const npc = DM_STATE.reference.npc_generation;
            return {
                personality: npc.personalities[Math.floor(Math.random() * npc.personalities.length)],
                motivation: npc.motivations[Math.floor(Math.random() * npc.motivations.length)],
                quirk: npc.quirks[Math.floor(Math.random() * npc.quirks.length)]
            };
        }

        // Get monster stats
        function getMonsterStats(monsterName) {
            if (!DM_STATE.reference?.monsters) return null;
            
            // Search through all CR categories
            for (const crCategory of Object.values(DM_STATE.reference.monsters)) {
                if (crCategory[monsterName]) {
                    return crCategory[monsterName];
                }
            }
            return null;
        }

        // Determine skill check DC based on difficulty
        function getSkillCheckDC(difficulty = 'medium') {
            if (!DM_STATE.reference?.skill_checks?.dc_guidelines) {
                // Fallback DCs if reference not loaded
                const fallbackDCs = {
                    very_easy: 5,
                    easy: 10,
                    medium: 15,
                    hard: 20,
                    very_hard: 25
                };
                return fallbackDCs[difficulty] || 15;
            }
            
            return DM_STATE.reference.skill_checks.dc_guidelines[difficulty] || 15;
        }

        // ===============================
        // DYNAMIC STORY GENERATION SYSTEM
        // ===============================
        
        // Story state tracking
        const STORY_STATE = {
            currentChapter: 'opening',
            plotThreads: [],
            activeQuests: [],
            completedEvents: [],
            worldState: {},
            narrativeTension: 1,
            storyBeats: []
        };

        // Generate dynamic story hooks based on context
        function generateStoryHook() {
            const hooks = [
                {
                    type: 'mystery',
                    hooks: [
                        "Strange disappearances have plagued the nearby village - livestock vanishing without a trace, and now people...",
                        "An ancient map was discovered in the wall of the old tavern during renovations, marking a location that shouldn't exist...",
                        "Every full moon, ghostly music echoes from the abandoned manor on the hill. Last night wasn't a full moon..."
                    ]
                },
                {
                    type: 'danger',
                    hooks: [
                        "Smoke rises on the horizon - the peaceful hamlet you were heading to appears to be under attack!",
                        "A blood-curdling scream pierces the night, followed by an unnatural silence that sets your teeth on edge...",
                        "The bridge ahead has been destroyed, and fresh tracks suggest it wasn't an accident. Someone doesn't want you to cross..."
                    ]
                },
                {
                    type: 'opportunity',
                    hooks: [
                        "A wealthy merchant's caravan lies overturned beside the road, goods scattered but no bodies in sight...",
                        "You stumble upon a hidden entrance behind a waterfall, ancient runes glowing faintly around its edges...",
                        "A dying knight presses a sealed letter into your hands, gasping 'The king... must not... know...' before expiring..."
                    ]
                },
                {
                    type: 'social',
                    hooks: [
                        "Two rival factions approach your group simultaneously, each demanding you choose a side in their conflict...",
                        "A mysterious figure in fine robes has been asking about you by name in every tavern in town...",
                        "The local lord has heard of your exploits and 'requests' your presence at court immediately..."
                    ]
                }
            ];
            
            const selectedType = hooks[Math.floor(Math.random() * hooks.length)];
            const selectedHook = selectedType.hooks[Math.floor(Math.random() * selectedType.hooks.length)];
            
            return {
                type: selectedType.type,
                description: selectedHook
            };
        }

        // Create opening narration based on campaign scenario
        function startAdventureNarration() {
            const campaign = window.currentCampaign || {};
            const scenario = campaign.scenario || 'forgotten_realms';
            const party = window.partyCharacters || [];
            
            // Build personalized opening based on scenario
            let opening = "";
            let voiceOpening = "";
            
            // Scenario-specific openings
            const scenarioOpenings = {
                forgotten_realms: {
                    text: "The sun rises over the Sword Coast as your party gathers at the crossroads outside Waterdeep. The morning mist clings to the cobblestones, and merchants are already hawking their wares.",
                    voice: "Welcome, brave adventurers, to the Forgotten Realms! The sun rises over the Sword Coast as your party gathers at the crossroads outside Waterdeep. The morning mist clings to the ancient cobblestones, and merchants are already hawking their wares. The city of splendors awaits, but your destiny lies elsewhere..."
                },
                ravenloft: {
                    text: "The mists part reluctantly, revealing a land shrouded in perpetual twilight. Barovia stretches before you, a realm where hope itself seems a distant memory.",
                    voice: "Welcome... to Barovia. The mists have chosen you, though whether for salvation or damnation remains to be seen. The land itself watches your every move, and somewhere in the distance, a wolf howls - or was it something worse? You stand at the gates of a realm where nightmares walk freely..."
                },
                eberron: {
                    text: "The lightning rail hisses to a stop at Sharn Station. The City of Towers stretches impossibly high above and deep below, magical lights dancing between the spires.",
                    voice: "Welcome to Eberron, where magic and technology intertwine! The lightning rail hisses to a stop at Sharn Station. The City of Towers stretches impossibly high above you and deep below, with bridges of magical force connecting the massive spires. Adventure awaits in every shadow of this city of wonders!"
                },
                spelljammer: {
                    text: "Your spelljamming vessel drifts through the phlogiston, the rainbow-colored chaotic matter swirling outside the crystal sphere. A new world awaits.",
                    voice: "Greetings, spacefarers! Your spelljamming vessel glides through the rainbow chaos of the phlogiston. The helm thrums with magical energy beneath your feet, and through the viewport, you can see a new crystal sphere approaching. What wonders and terrors await in this uncharted realm of wildspace?"
                },
                custom: {
                    text: "Your adventure begins at a crossroads, both literal and metaphorical. The path ahead promises danger, glory, and discoveries beyond imagination.",
                    voice: "Welcome, heroes, to a world of infinite possibilities! Your journey begins here, at this fateful moment when ordinary lives transform into legend. The very air seems to thrum with potential. What tale will you write in the annals of history?"
                }
            };
            
            const selectedOpening = scenarioOpenings[scenario] || scenarioOpenings.custom;
            opening = selectedOpening.text;
            voiceOpening = selectedOpening.voice;
            
            // Add a story hook
            const hook = generateStoryHook();
            opening += ` ${hook.description}`;
            voiceOpening += ` ${hook.description}`;
            
            // Add party-specific flavor
            if (party.length > 0) {
                const partySize = party.length === 1 ? "alone" : `as a party of ${party.length}`;
                const partyClasses = party.map(c => c.class).join(", ");
                opening += ` You stand ${partySize}, ready to face whatever comes.`;
                voiceOpening += ` You stand ${partySize} - ${partyClasses} - ready to face whatever destiny awaits. What do you do?`;
            } else {
                opening += " What will you do?";
                voiceOpening += " The choice, as always, is yours. What do you do?";
            }
            
            // Display the opening narration
            const openingMessage = `
                <div class="dm-message voice-message opening-narration">
                    <div class="message-header">
                        <strong>üé≠ Dungeon Master</strong>
                        <span class="voice-indicator-small">üîä</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p class="opening-text">${opening}</p>
                        <p class="dm-prompt"><em>What do you do?</em></p>
                    </div>
                </div>
            `;
            
            appendToConversation(openingMessage);
            
            // Store the hook in story state
            STORY_STATE.plotThreads.push(hook);
            STORY_STATE.currentChapter = 'adventure_start';
            
            // Speak the opening
            setTimeout(() => {
                speakAsDM(voiceOpening);
            }, 500);
        }

        // Generate dynamic story developments based on player actions
        function generateStoryDevelopment(playerAction, context = {}) {
            const action = playerAction.toLowerCase();
            const currentTension = STORY_STATE.narrativeTension;
            
            // Check if action relates to existing plot threads
            const relevantThread = STORY_STATE.plotThreads.find(thread => 
                action.includes(thread.type) || 
                thread.keywords?.some(keyword => action.includes(keyword))
            );
            
            // Generate consequences that build on previous events
            if (STORY_STATE.completedEvents.length > 0) {
                const lastEvent = STORY_STATE.completedEvents[STORY_STATE.completedEvents.length - 1];
                
                // Create callbacks to previous events
                if (Math.random() < 0.3) { // 30% chance of callback
                    return {
                        text: `Your actions remind you of ${lastEvent.description}. The consequences of that choice echo here...`,
                        voice: `Interesting... your current choice mirrors what happened when ${lastEvent.description}. The threads of fate are weaving together. How will you handle it differently this time?`,
                        continuity: true
                    };
                }
            }
            
            // Escalate tension naturally
            if (currentTension < 5 && Math.random() < 0.4) {
                STORY_STATE.narrativeTension++;
                return generateComplication();
            }
            
            // Resolution opportunities at high tension
            if (currentTension >= 7 && Math.random() < 0.5) {
                return generateClimax();
            }
            
            // Default to contextual development
            return generateContextualDevelopment(playerAction, context);
        }

        // Generate complications to raise stakes
        function generateComplication() {
            const complications = [
                {
                    text: "Suddenly, things take an unexpected turn! A new threat emerges from an unforeseen direction.",
                    voice: "Wait! Something's not right here. You notice movement in the shadows - you're not alone! This just became much more dangerous. How do you respond to this new threat?"
                },
                {
                    text: "Your action has unintended consequences! The situation grows more complex.",
                    voice: "Oh, this is interesting! Your action has triggered something unexpected. The simple task has become a web of complications. What started as straightforward is now anything but! What's your next move?"
                },
                {
                    text: "A moral dilemma presents itself - the right choice is no longer clear.",
                    voice: "Hold on... this situation is more complex than it appeared. You're faced with a choice where any action could have serious consequences for innocent people. There's no perfect solution here. What will you prioritize?"
                }
            ];
            
            return complications[Math.floor(Math.random() * complications.length)];
        }

        // Generate climactic moments
        function generateClimax() {
            const climaxes = [
                {
                    text: "This is it - the moment of truth! Everything has led to this critical juncture.",
                    voice: "THIS IS IT! The moment of truth has arrived! Everything you've done has led to this crucial moment. The fate of everyone involved hangs in the balance. This is your chance to be heroes! What do you do?"
                },
                {
                    text: "The tension reaches its breaking point! The situation demands immediate decisive action.",
                    voice: "The tension snaps like a bowstring! No more time for deliberation - the moment demands action NOW! Success or failure, glory or disaster, it all comes down to this. Make your choice!"
                }
            ];
            
            STORY_STATE.narrativeTension = Math.max(1, STORY_STATE.narrativeTension - 3); // Reset tension after climax
            return climaxes[Math.floor(Math.random() * climaxes.length)];
        }

        // Generate contextual story based on action type
        function generateContextualDevelopment(playerAction, context) {
            // This will evolve the story based on what the player does
            const developments = {
                explore: [
                    "Your exploration reveals more than expected - the plot thickens!",
                    "As you investigate, you uncover clues that connect to earlier events.",
                    "Your discovery opens new possibilities and raises new questions."
                ],
                combat: [
                    "The battle reveals the true stakes - this is bigger than you thought!",
                    "Victory brings new information, but also new enemies.",
                    "The fight changes everything - alliances shift and secrets are revealed."
                ],
                social: [
                    "Your words have more impact than expected - relationships permanently change.",
                    "The conversation reveals hidden motivations and secret alliances.",
                    "Your diplomatic approach opens unexpected doors - or closes them forever."
                ],
                puzzle: [
                    "Solving this reveals a piece of a larger mystery.",
                    "The solution brings knowledge, but knowledge can be dangerous.",
                    "Your success here cascades into new opportunities elsewhere."
                ]
            };
            
            // Determine action category
            let category = 'explore'; // default
            if (playerAction.includes('attack') || playerAction.includes('fight')) category = 'combat';
            if (playerAction.includes('talk') || playerAction.includes('persuade')) category = 'social';
            if (playerAction.includes('solve') || playerAction.includes('figure')) category = 'puzzle';
            
            const options = developments[category];
            const selected = options[Math.floor(Math.random() * options.length)];
            
            // Add it to story beats
            STORY_STATE.storyBeats.push({
                action: playerAction,
                development: selected,
                timestamp: Date.now()
            });
            
            return {
                text: selected,
                voice: `${selected} What do you do next?`,
                category: category
            };
        }

        // Generate voice-enabled DM response with real DM personality
        async function generateVoiceDMResponse(playerAction) {
            const action = playerAction.toLowerCase();
            const campaign = window.currentCampaign || {};
            
            // Try OpenAI first if enabled and configured
            if (openAIConfig.enabled && openAIConfig.apiKey) {
                try {
                    updateVoiceStatus('AI DM thinking...', 'processing');
                    const aiResponse = await generateOpenAIDMResponse(playerAction);
                    if (aiResponse) {
                        // Add story development tracking
                        if (Math.random() < 0.3) { // 30% chance to add story development
                            const storyDev = generateStoryDevelopment(playerAction);
                            if (storyDev) {
                                STORY_STATE.completedEvents.push({
                                    action: playerAction,
                                    development: storyDev.text,
                                    timestamp: Date.now()
                                });
                            }
                        }
                        
                        displayDMResponse(aiResponse.response, aiResponse.voice);
                        updateVoiceStatus('Ready to listen', 'ready');
                        return;
                    }
                } catch (error) {
                    console.error('OpenAI generation failed, falling back to templates:', error);
                    updateVoiceStatus('AI failed, using templates...', 'processing');
                }
            }
            
            // Combat responses - much more engaging
            if (action.includes('attack') || action.includes('fight') || action.includes('combat') || action.includes('hit') || action.includes('strike')) {
                const combatResponses = [
                    {
                        response: "Your blade flashes in the light as you move to strike! Roll for initiative - we're entering combat! What's your target?",
                        voice: "Steel rings as weapons are drawn! Roll for initiative everyone! Who or what are you attacking, and describe your approach!",
                        requiresDMRoll: true,
                        rollType: 'initiative'
                    },
                    {
                        response: "Violence erupts! The air crackles with tension as battle is joined! Everyone roll initiative!",
                        voice: "The peaceful moment shatters into chaos! Weapons drawn, spells at the ready - roll for initiative! Describe your opening move!",
                        requiresDMRoll: true,
                        rollType: 'initiative'
                    },
                    {
                        response: "Your hostile intent is clear! Combat begins - roll initiative and tell me your first action!",
                        voice: "Battle is joined! The clash of combat echoes through the area! Roll initiative and tell me - how does your character react in this critical moment?",
                        requiresDMRoll: true,
                        rollType: 'initiative'
                    }
                ];
                DM_STATE.combatActive = true;
                return combatResponses[Math.floor(Math.random() * combatResponses.length)];
            }
            
            // Investigation/Perception - more descriptive
            if (action.includes('look') || action.includes('search') || action.includes('investigate') || action.includes('examine') || action.includes('inspect')) {
                const investigateResponses = [
                    {
                        response: "Your trained eye scans the area methodically. Roll Investigation or Perception - d20 plus your modifier!",
                        voice: "You focus intently, your senses sharpening as you examine every detail. Roll an Investigation or Perception check - what specifically draws your attention?",
                        requiresDMRoll: true,
                        rollType: 'perception'
                    },
                    {
                        response: "Something about this place feels... different. Make an Investigation check to see what you discover!",
                        voice: "The hairs on your neck stand up - something here deserves closer inspection. Roll Investigation and tell me where you're focusing your search!",
                        requiresDMRoll: true,
                        rollType: 'investigation'
                    },
                    {
                        response: "You take a moment to carefully observe your surroundings. Roll Perception and add your Wisdom modifier!",
                        voice: "Time seems to slow as you take in every detail around you. Roll a Perception check - are you looking for danger, treasure, or something else?",
                        requiresDMRoll: true,
                        rollType: 'perception'
                    }
                ];
                return investigateResponses[Math.floor(Math.random() * investigateResponses.length)];
            }
            
            // Social interactions - more nuanced
            if (action.includes('talk') || action.includes('speak') || action.includes('say') || action.includes('ask') || action.includes('tell')) {
                const socialResponses = [
                    {
                        response: "The figure turns to face you, eyebrow raised. Your words will matter here - make a Persuasion, Deception, or Intimidation check!",
                        voice: "The figure's full attention locks onto you, weighing every word. How are you approaching this - with honeyed words, clever lies, or implied threats? Roll the appropriate Charisma check!",
                        requiresDMRoll: true,
                        rollType: 'charisma'
                    },
                    {
                        response: "Your voice cuts through the tension. The NPC's reaction depends on your approach - roll a Charisma-based skill check!",
                        voice: "Your words hang heavy in the air between you. I can see the gears turning in their mind. Are you being persuasive, deceptive, or intimidating? Make your roll and tell me your exact words!",
                        requiresDMRoll: true,
                        rollType: 'charisma'
                    }
                ];
                return socialResponses[Math.floor(Math.random() * socialResponses.length)];
            }
            
            // Movement and exploration - more atmospheric
            if (action.includes('go') || action.includes('move') || action.includes('walk') || action.includes('enter') || action.includes('leave')) {
                const moveResponses = [
                    {
                        response: "You move forward, each step taking you deeper into the unknown. The atmosphere shifts noticeably...",
                        voice: "Your footsteps echo as you advance. The air grows thick with possibility. Are you moving cautiously or boldly? And keep your eyes open - this place holds secrets!",
                        requiresDMRoll: false
                    },
                    {
                        response: "The path ahead beckons. As you progress, new details emerge from the shadows. Roll Perception to see what you notice!",
                        voice: "You press onward, the environment changing subtly around you. Roll a Perception check as you move - something here might be worth your attention. How quickly are you traveling?",
                        requiresDMRoll: true,
                        rollType: 'perception'
                    }
                ];
                return moveResponses[Math.floor(Math.random() * moveResponses.length)];
            }
            
            // Stealth actions - tension building
            if (action.includes('sneak') || action.includes('hide') || action.includes('stealth') || action.includes('quiet')) {
                return {
                    response: "You become one with the shadows, moving like a ghost. Roll Stealth - d20 plus Dexterity modifier!",
                    voice: "Silent as death itself, you slip into concealment. Your heart pounds but your movements are smooth. Roll a Stealth check and tell me - what are you trying to avoid being noticed by?",
                    requiresDMRoll: true,
                    rollType: 'stealth'
                };
            }
            
            // Spellcasting - magical flair
            if (action.includes('cast') || action.includes('spell') || action.includes('magic') || action.includes('cantrip')) {
                return {
                    response: "Arcane energy crackles around your fingers as you begin the incantation! What spell are you casting?",
                    voice: "The Weave responds to your call! Mystical energy swirls around you as reality bends to your will! What spell are you casting, at what level, and who or what is your target? Describe the casting!",
                    requiresDMRoll: false,
                    spellcasting: true
                };
            }
            
            // Skill checks and abilities
            if (action.includes('climb') || action.includes('jump') || action.includes('swim') || action.includes('lift')) {
                return {
                    response: "Your muscles tense as you attempt this physical feat. Roll Athletics - d20 plus Strength modifier!",
                    voice: "Time to test your physical prowess! Your body coils like a spring ready to release. Roll an Athletics check and describe your technique - are you going for power or finesse?",
                    requiresDMRoll: true,
                    rollType: 'athletics'
                };
            }
            
            // Rest and recovery
            if (action.includes('rest') || action.includes('sleep') || action.includes('camp')) {
                return {
                    response: "You find a suitable spot to rest. Are you taking a short rest (1 hour) or a long rest (8 hours)? Roll Perception to ensure the area is safe!",
                    voice: "Exhaustion weighs on you, and rest is needed. You scout for a defensible position. Will this be a short rest to catch your breath, or a long rest to fully recover? Roll Perception to check for danger while you rest!",
                    requiresDMRoll: true,
                    rollType: 'perception'
                };
            }
            
            // Default responses - still engaging
            const defaultResponses = [
                {
                    response: "That's an interesting approach! The world responds to your actions in unexpected ways. Tell me more about what you're trying to accomplish.",
                    voice: "Now that's thinking outside the box! Your action sets events in motion that even I didn't anticipate. Give me more details about your plan - what's your end goal here?",
                    requiresDMRoll: Math.random() < 0.4
                },
                {
                    response: "Your choice ripples through the scene like a stone in still water. Something is about to happen...",
                    voice: "Bold move! The consequences of your action are already beginning to manifest. The tension in the air is palpable. What are you prepared to do if this goes sideways?",
                    requiresDMRoll: Math.random() < 0.5
                },
                {
                    response: "The dice of fate are rolling behind the cosmic screen! Your action triggers a chain of events...",
                    voice: "Ah, the plot thickens! Your decision opens new possibilities I hadn't considered. The story takes an interesting turn here. How committed are you to this course of action?",
                    requiresDMRoll: Math.random() < 0.3
                }
            ];
            
            const selected = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            
            // Add campaign flavor
            if (campaign.scenario === 'ravenloft' && Math.random() < 0.3) {
                selected.response += " The mists seem to thicken around you...";
                selected.voice += " And I should mention - the dark mists of Barovia seem to be taking notice of your actions...";
            } else if (campaign.scenario === 'spelljammer' && Math.random() < 0.3) {
                selected.response += " The stars above seem to shift slightly...";
                selected.voice += " The cosmic void around your ship seems to pulse with energy...";
            }
            
            // Incorporate dynamic story development
            const storyDev = generateStoryDevelopment(playerAction);
            if (storyDev && Math.random() < 0.6) { // 60% chance to add story development
                selected.response += ` ${storyDev.text}`;
                selected.voice += ` ${storyDev.voice}`;
            }
            
            // Handle dice rolls
            if (selected.requiresDMRoll) {
                handleDMDiceRoll(selected, playerAction);
            } else {
                displayDMResponse(selected.response, selected.voice);
            }
        }
        
        // Handle DM dice rolling
        function handleDMDiceRoll(responseObj, playerAction) {
            const rollTypes = {
                investigation: { die: 20, modifier: 0, description: "Investigation check" },
                initiative: { die: 20, modifier: 2, description: "Initiative roll" },
                persuasion: { die: 20, modifier: 1, description: "Reaction roll" },
                random: { die: 20, modifier: 0, description: "Outcome roll" }
            };
            
            const rollType = rollTypes[responseObj.rollType] || rollTypes.random;
            const roll = Math.floor(Math.random() * rollType.die) + 1;
            const total = roll + rollType.modifier;
            
            // Display the initial response
            displayDMResponse(responseObj.response, responseObj.voice);
            
            // Add DM dice roll after a delay
            setTimeout(() => {
                const rollMessage = `
                    <div class="dm-roll">
                        <div class="message-header">
                            <strong>üé≤ DM Roll</strong>
                            <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="message-content">
                            <p><strong>${rollType.description}:</strong> d${rollType.die} + ${rollType.modifier} = <span class="roll-result">${total}</span> (rolled ${roll})</p>
                        </div>
                    </div>
                `;
                
                appendToConversation(rollMessage);
                
                // Generate follow-up response based on roll result
                setTimeout(() => {
                    generateRollBasedResponse(rollType.description, total, playerAction);
                }, 1500);
                
            }, 2000);
        }
        
        // Generate response based on DM dice roll result with proper D&D flair
        function generateRollBasedResponse(rollDescription, total, originalAction) {
            let followupResponse = "";
            let followupVoice = "";
            const rollType = rollDescription.toLowerCase();
            
            // Natural 20 - Critical Success!
            if (total === 20 || total >= 25) {
                const criticalSuccesses = [
                    {
                        response: "NATURAL 20! Critical Success! The dice gods smile upon you! Your action succeeds spectacularly, creating an opportunity for advantage!",
                        voice: "NATURAL TWENTY! Critical success! The fates themselves conspire in your favor! Not only does your action succeed brilliantly, but you've created an opening for something more! Describe your moment of triumph!"
                    },
                    {
                        response: "CRIT! Legendary success! Your action succeeds so well that it becomes the stuff of tavern tales!",
                        voice: "CRITICAL HIT on the skill check! This is the kind of moment bards write songs about! Your success is so complete it changes the situation entirely in your favor! How does your character celebrate this incredible moment?"
                    }
                ];
                const crit = criticalSuccesses[Math.floor(Math.random() * criticalSuccesses.length)];
                followupResponse = crit.response;
                followupVoice = crit.voice;
            }
            // High Success (18-19)
            else if (total >= 18) {
                if (rollType.includes('stealth')) {
                    followupResponse = "Like a shadow given form, you move completely undetected. You're practically invisible!";
                    followupVoice = "You've become one with the shadows themselves! No one has any idea you're there. You have complete tactical advantage - what's your next move from the shadows?";
                } else if (rollType.includes('perception') || rollType.includes('investigation')) {
                    followupResponse = "Your keen senses reveal hidden details others would miss! You notice something very important...";
                    followupVoice = "Your sharp eyes catch every detail! Not only do you see what you were looking for, but you notice something else entirely - something that changes everything! What catches your attention most?";
                } else if (rollType.includes('persuasion') || rollType.includes('charisma')) {
                    followupResponse = "Your words strike the perfect chord! The NPC is not just convinced - they're eager to help!";
                    followupVoice = "Your silver tongue works its magic perfectly! The NPC's entire demeanor shifts - they're not just willing to help, they're enthusiastic about it! They lean in closer and say...";
                } else if (rollType.includes('initiative')) {
                    followupResponse = "Lightning reflexes! You act before anyone else can even blink! You have the drop on your enemies!";
                    followupVoice = "Incredible reflexes! Time seems to slow as you spring into action before anyone else can react! You have complete control of the battlefield's opening moments - make them count!";
                } else {
                    followupResponse = "Exceptional success! Fortune favors the bold, and you've proven very bold indeed!";
                    followupVoice = "Outstanding! Your skill and luck combine for a truly exceptional result! The dice love you today! How do you capitalize on this golden opportunity?";
                }
            }
            // Good Success (15-17)
            else if (total >= 15) {
                if (rollType.includes('combat') || rollType.includes('attack')) {
                    followupResponse = "Solid hit! Your attack finds its mark with satisfying impact!";
                    followupVoice = "A clean hit! Your strike lands true, and you can see the effect immediately! Your enemy staggers - press the advantage!";
                } else {
                    followupResponse = "Success! Your action achieves exactly what you intended, clean and effective!";
                    followupVoice = "Well done! Your approach works perfectly, achieving your goal with style! The path forward is clear - what's your next step?";
                }
            }
            // Moderate Success (10-14)
            else if (total >= 10) {
                followupResponse = "You succeed, but it's not pretty. The job gets done with a few complications along the way.";
                followupVoice = "Success, but barely! You manage to accomplish your goal, though not without drawing some unwanted attention or creating a new problem. How do you handle the complication?";
            }
            // Close Failure (5-9)
            else if (total >= 5) {
                followupResponse = "So close! You almost succeed, but fall just short. However, all is not lost - you might try a different approach.";
                followupVoice = "Almost! You were so close to success, but not quite there. The good news is you learned something from the attempt. Want to try a different tactic, or double down on this one?";
            }
            // Natural 1 or Critical Failure
            else if (total === 1 || total <= 4) {
                const criticalFailures = [
                    {
                        response: "NATURAL 1! Critical failure! The dice betray you spectacularly! This is going to hurt...",
                        voice: "OOF! Natural one! Critical failure! Not only does your action fail, but it fails in the most spectacular way possible! Something has gone terribly, hilariously wrong! How does your character react to this disaster?"
                    },
                    {
                        response: "Catastrophic failure! Your action backfires completely, creating a whole new problem!",
                        voice: "Oh no! That's a critical failure! Your attempt goes so wrong it actually makes things worse! The universe itself seems to be laughing at you! Quick, damage control - what do you do?"
                    }
                ];
                const fail = criticalFailures[Math.floor(Math.random() * criticalFailures.length)];
                followupResponse = fail.response;
                followupVoice = fail.voice;
            }
            // Regular Failure
            else {
                followupResponse = "Failure. Your action doesn't work as intended, and the situation remains challenging.";
                followupVoice = "That's a failure. Your attempt doesn't achieve what you hoped, and you'll need to reconsider your approach. The situation is getting tense - what's plan B?";
            }
            
            displayDMResponse(followupResponse, followupVoice);
        }
        
        // Display DM response with voice
        function displayDMResponse(textResponse, voiceResponse) {
            const responseMessage = `
                <div class="dm-message voice-message">
                    <div class="message-header">
                        <strong>üé≠ Dungeon Master</strong>
                        <span class="voice-indicator-small">üîä</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p>${textResponse}</p>
                        <p class="dm-prompt"><em>What do you do next?</em></p>
                    </div>
                </div>
            `;
            
            appendToConversation(responseMessage);
            
            // Speak the response
            setTimeout(() => {
                speakAsDM(voiceResponse || textResponse);
            }, 500);
        }
        
        // Legacy text-only function (fallback)
        function generateDMResponse(playerAction) {
            const responses = [
                {
                    condition: playerAction.toLowerCase().includes('left') || playerAction.toLowerCase().includes('forest'),
                    response: "You venture deeper into the forest. The strange lights dance between the ancient trees, leading you to a hidden clearing where an old stone altar sits covered in glowing runes. A soft humming fills the air."
                },
                {
                    condition: playerAction.toLowerCase().includes('right') || playerAction.toLowerCase().includes('settlement'),
                    response: "You approach the settlement, which turns out to be a small trading post. A weathered innkeeper greets you warmly, offering hot food and tales of recent strange happenings in the region."
                },
                {
                    condition: playerAction.toLowerCase().includes('investigate') || playerAction.toLowerCase().includes('examine'),
                    response: "Your investigation reveals more than you initially expected. Roll a d20 + your Investigation modifier to see what you discover!"
                },
                {
                    condition: playerAction.toLowerCase().includes('attack') || playerAction.toLowerCase().includes('fight'),
                    response: "Combat begins! Roll for initiative! The tension in the air is palpable as weapons are drawn and spells are prepared."
                },
                {
                    condition: playerAction.toLowerCase().includes('talk') || playerAction.toLowerCase().includes('speak'),
                    response: "Your words carry weight in this moment. The NPC listens intently, their expression shifting as they consider your words carefully."
                }
            ];
            
            // Find matching response or use default
            let dmResponse = responses.find(r => r.condition)?.response || 
                "Interesting choice! The consequences of your action begin to unfold before you. The world reacts to your decision in ways both expected and surprising.";
            
            // Add some dynamic elements based on campaign
            const campaign = window.currentCampaign;
            if (campaign?.moralComplexity === 'morally_gray') {
                dmResponse += " The moral implications of this choice are not immediately clear...";
            }
            
            const responseMessage = `
                <div class="dm-message">
                    <div class="message-header">
                        <strong>üé≠ Dungeon Master</strong>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        <p>${dmResponse}</p>
                        <p class="dm-prompt"><em>What do you do next?</em></p>
                    </div>
                </div>
            `;
            
            appendToConversation(responseMessage);
        }
        
        // Roll dice
        function rollDice() {
            const dice = ['d4', 'd6', 'd8', 'd10', 'd12', 'd20'];
            const selectedDie = prompt('Which die do you want to roll? (d4, d6, d8, d10, d12, d20)', 'd20');
            
            if (dice.includes(selectedDie)) {
                const sides = parseInt(selectedDie.substring(1));
                const result = Math.floor(Math.random() * sides) + 1;
                
                const rollMessage = `
                    <div class="dice-roll">
                        <div class="message-header">
                            <strong>üé≤ Dice Roll</strong>
                            <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="message-content">
                            <p><strong>${getActiveCharacterName()}</strong> rolled a <strong>${selectedDie}</strong>: <span class="roll-result">${result}</span></p>
                        </div>
                    </div>
                `;
                
                appendToConversation(rollMessage);
            }
        }
        
        // Initiate quick actions
        function initiateAction(actionType) {
            const actions = {
                combat: "I want to initiate combat!",
                explore: "I want to explore the area more thoroughly.",
                rest: "I want to take a rest to recover.",
                inventory: "I want to check my inventory and equipment."
            };
            
            const input = document.getElementById('player-input');
            input.value = actions[actionType] || "I want to take an action.";
            sendPlayerAction();
        }
        
        // Helper functions
        function getActiveCharacterName() {
            const characters = window.partyCharacters || [];
            return characters.length > 0 ? characters[0].name : 'Adventurer';
        }
        
        function appendToConversation(messageHTML) {
            const history = document.getElementById('conversation-history');
            if (history) {
                history.innerHTML += messageHTML;
                history.scrollTop = history.scrollHeight;
                
                // Save conversation to campaign
                if (window.currentCampaign) {
                    saveCurrentCampaignData();
                }
            }
        }
        
        function updateGameStatus(location, time, weather) {
            document.getElementById('current-location').textContent = location;
            document.getElementById('current-time').textContent = time;
            document.getElementById('current-weather').textContent = weather;
        }
    </script>

    <!-- Initialize Application -->
    <script type="module">
        // Check browser compatibility first
        const isModuleSupported = 'noModule' in HTMLScriptElement.prototype;
        const isFileProtocol = window.location.protocol === 'file:';
        
        if (isFileProtocol) {
            console.warn('‚ö†Ô∏è Running from file:// protocol. ES modules may not work properly.');
            console.log('üí° For full functionality, serve this app from a web server (e.g., python -m http.server)');
        }
        
        // Import the core module
        import './js/core.js';
        
        // Application initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingProgress = document.getElementById('loading-progress');
            const loadingText = document.getElementById('loading-text');
            const app = document.getElementById('app');
            
            function updateProgress(progress, text) {
                loadingProgress.style.width = progress + '%';
                loadingText.textContent = text;
                console.log(`üìä ${progress}%: ${text}`);
            }
            
            try {
                updateProgress(10, 'Loading ancient scrolls...');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                updateProgress(20, 'Checking browser compatibility...');
                // Browser checks
                if (window.location.protocol === 'file:') {
                    console.warn('üö® File protocol detected - this may cause issues');
                }
                
                updateProgress(30, 'Importing core modules...');
                // Wait for DNDCore to be available globally
                let attempts = 0;
                while (!window.DNDCore && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    attempts++;
                    if (attempts % 10 === 0) {
                        updateProgress(30 + (attempts / 2), `Waiting for core module... (${attempts}/100)`);
                    }
                }
                
                if (!window.DNDCore) {
                    throw new Error('DNDCore module failed to load after 5 seconds. This usually indicates a file:// protocol issue or JavaScript error.');
                }
                
                updateProgress(60, 'Core module loaded successfully');
                console.log('‚úÖ DNDCore is available');
                
                updateProgress(70, 'Initializing application modules...');
                
                // Listen for core loading progress
                window.DNDCore.on('core:loading_progress', (event) => {
                    const { loaded, total, current } = event.detail;
                    const moduleProgress = 70 + ((loaded / total) * 20);
                    updateProgress(moduleProgress, `Loading ${current}... (${loaded}/${total})`);
                });
                
                updateProgress(75, 'Starting core initialization...');
                
                // Initialize the core application with timeout
                const initPromise = window.DNDCore.init();
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Initialization timed out after 30 seconds')), 30000);
                });
                
                await Promise.race([initPromise, timeoutPromise]);
                
                updateProgress(95, 'Finalizing setup...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(100, 'Welcome, adventurer!');
                console.log('üéâ Application initialized successfully');
                
                // Hide loading screen and show app
                setTimeout(() => {
                    console.log('üé¨ Hiding loading screen');
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        app.style.opacity = '1';
                        console.log('‚úÖ Application fully loaded and visible');
                    }, 500);
                }, 300);
                
            } catch (error) {
                loadingText.textContent = `Error: ${error.message}`;
                console.error('Application initialization failed:', error);
                
                // Show detailed error in the error container
                const errorContainer = document.getElementById('error-container');
                if (errorContainer) {
                    errorContainer.style.display = 'block';
                    
                    let helpText = '';
                    if (window.location.protocol === 'file:') {
                        helpText = `
                            <div class="error-help">
                                <h3>üí° Quick Fix</h3>
                                <p>You're running this from a file:// URL, which causes security restrictions.</p>
                                <p><strong>Solution:</strong> Run a local server:</p>
                                <ol>
                                    <li>Open terminal/command prompt in this folder</li>
                                    <li>Run: <code>python -m http.server 8000</code></li>
                                    <li>Open: <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></li>
                                </ol>
                                <p>Or use the provided <code>start-server.py</code> script.</p>
                            </div>
                        `;
                    }
                    
                    errorContainer.innerHTML = `
                        <div class="critical-error">
                            <h2>‚ö†Ô∏è Initialization Error</h2>
                            <p>The D&D Voice Adventure app failed to initialize.</p>
                            ${helpText}
                            <details>
                                <summary>Technical Details</summary>
                                <pre>${error.stack || error.message}</pre>
                            </details>
                            <div class="error-actions">
                                <button onclick="location.reload()">üîÑ Reload</button>
                                <button onclick="window.open('README-SERVER.md', '_blank')">üìñ Help Guide</button>
                            </div>
                        </div>
                    `;
                }
                
                // Hide loading screen after showing error
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1000);
            }
        });
        
        // Service Worker Registration for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (window.DNDCore) {
                window.DNDCore.handleCriticalError(event.error);
            }
        });
        
        // Prevent default drag and drop to avoid accidental navigation
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());

        // Initialize AI DM settings after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load OpenAI config from localStorage
            const enabled = localStorage.getItem('openai_enabled') === 'true';
            if (enabled) {
                openAIConfig.enabled = true;
            }

            // Add event listeners for AI engine radio buttons
            const aiRadioButtons = document.querySelectorAll('input[name="aiEngine"]');
            aiRadioButtons.forEach(radio => {
                radio.addEventListener('change', toggleOpenAISettings);
            });

            // Add event listener for creativity slider
            const creativitySlider = document.getElementById('ai-creativity');
            if (creativitySlider) {
                creativitySlider.addEventListener('input', function() {
                    document.getElementById('ai-creativity-display').textContent = this.value + '%';
                });
            }
        });
    </script>
</body>
</html>