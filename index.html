<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D&D Voice Adventure - A comprehensive tabletop RPG companion with voice integration, inspired by Baldur's Gate 3 and Gloomhaven.">
    <meta name="keywords" content="D&D, Dungeons Dragons, RPG, tabletop, voice, adventure, campaign">
    <meta name="author" content="D&D Voice Adventure">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://taylor834-sketch.github.io/AI-DND-DM/">
    <meta property="og:title" content="D&D Voice Adventure">
    <meta property="og:description" content="Experience immersive tabletop RPG adventures with voice integration and atmospheric storytelling.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://taylor834-sketch.github.io/AI-DND-DM/"
    <meta property="twitter:title" content="D&D Voice Adventure">
    <meta property="twitter:description" content="Experience immersive tabletop RPG adventures with voice integration and atmospheric storytelling.">
    
    <title>D&D Voice Adventure</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="./css/main.css">
    
    <!-- Error Styles -->
    <style>
        .critical-error {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: #1a1a1a;
            border: 2px solid #ff4444;
            border-radius: 10px;
            color: white;
            font-family: 'Crimson Text', serif;
        }
        .critical-error h2 {
            color: #ff6666;
            margin-top: 0;
        }
        .error-help {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .error-help h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        .error-help code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        .error-actions {
            margin-top: 20px;
        }
        .error-actions button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .error-actions button:hover {
            background: #45a049;
        }
        .error-actions button:nth-child(2) {
            background: #2196F3;
        }
        .error-actions button:nth-child(2):hover {
            background: #1976D2;
        }
    </style>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./js/core.js" as="script">
    <link rel="preload" href="./css/main.css" as="style">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="dragon-symbol">üêâ</div>
            <h1 class="loading-title">D&D Voice Adventure</h1>
            <div class="loading-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
            <p class="loading-text" id="loading-text">Awakening ancient powers...</p>
        </div>
    </div>

    <!-- Error Container for Critical Errors -->
    <div id="error-container" class="error-container" style="display: none;"></div>

    <!-- Main Application Container -->
    <div id="app" class="app-container">
        <!-- Main Menu Screen -->
        <div id="mainMenu-screen" class="screen main-menu-screen active">
            <!-- Background Elements -->
            <div class="background-overlay"></div>
            <div class="particle-container" id="particle-container"></div>
            
            <!-- Header -->
            <header class="main-header">
                <div class="title-container">
                    <h1 class="main-title">
                        <span class="title-primary">D&D Voice</span>
                        <span class="title-secondary">Adventure</span>
                    </h1>
                    <p class="subtitle">Embark on Epic Journeys</p>
                </div>
            </header>

            <!-- Main Menu Navigation -->
            <nav class="main-menu">
                <div class="menu-container">
                    <button id="create-campaign-btn" class="menu-button primary-button">
                        <span class="button-icon">‚öîÔ∏è</span>
                        <span class="button-text">Create New Campaign</span>
                        <span class="button-description">Begin a fresh adventure</span>
                    </button>

                    <button id="continue-campaign-btn" class="menu-button secondary-button">
                        <span class="button-icon">üìñ</span>
                        <span class="button-text">Continue Campaign</span>
                        <span class="button-description">Resume your journey</span>
                    </button>

                    <button id="load-github-btn" class="menu-button secondary-button">
                        <span class="button-icon">‚òÅÔ∏è</span>
                        <span class="button-text">Load from GitHub</span>
                        <span class="button-description">Sync your adventures</span>
                    </button>

                    <button id="world-browser-btn" class="menu-button secondary-button">
                        <span class="button-icon">üåç</span>
                        <span class="button-text">World Browser</span>
                        <span class="button-description">Explore NPCs, locations, and lore</span>
                    </button>

                    <button id="settings-btn" class="menu-button tertiary-button">
                        <span class="button-icon">‚öôÔ∏è</span>
                        <span class="button-text">Settings</span>
                        <span class="button-description">Configure your experience</span>
                    </button>
                </div>
            </nav>

            <!-- Footer -->
            <footer class="main-footer">
                <div class="footer-content">
                    <p class="version-info">Version <span id="app-version">1.0.0</span></p>
                    <p class="github-link">
                        <a href="https://github.com/taylor834-sketch/AI-DND-DM" target="_blank" rel="noopener noreferrer">
                            View on GitHub
                        </a>
                    </p>
                </div>
            </footer>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen settings-screen">
            <div class="settings-container">
                <header class="screen-header">
                    <h2>Settings</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>
                
                <div class="settings-content">
                    <div class="settings-section">
                        <h3>Audio</h3>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="enable-audio"> Enable Audio Effects
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                Master Volume
                                <input type="range" id="master-volume" min="0" max="100" value="70">
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Display</h3>
                        <div class="setting-item">
                            <label>
                                <select id="theme-select">
                                    <option value="dark">Dark Theme</option>
                                    <option value="light">Light Theme</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                                Theme
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="enable-particles" checked> Enable Particles
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>GitHub Integration</h3>
                        <div class="setting-item">
                            <label>
                                GitHub Token
                                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                Repository
                                <input type="text" id="github-repo" placeholder="username/dnd-campaigns">
                            </label>
                        </div>
                        <button id="test-github-connection" class="secondary-button">Test Connection</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign List Screen -->
        <div id="campaignList-screen" class="screen campaign-list-screen">
            <div class="screen-header">
                <h2>Continue Campaign</h2>
                <button class="back-button" onclick="promptToSave('mainMenu')">‚Üê Back</button>
            </div>
            <div class="campaign-list-container">
                <div id="campaign-list-content">
                    <!-- Campaigns will be populated here -->
                </div>
            </div>
        </div>

        <!-- Campaign Creation Screen -->
        <div id="campaignCreation-screen" class="screen campaign-creation-screen">
            <div class="campaign-creation-container">
                <header class="screen-header">
                    <h2>Create New Campaign</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>
                
                <form id="campaign-creation-form" class="campaign-form" onsubmit="createCampaign(event); return false;">
                    <div class="form-section">
                        <h3>Campaign Details</h3>
                        
                        <div class="form-group">
                            <label for="campaign-name">Campaign Name *</label>
                            <input type="text" id="campaign-name" name="campaignName" required 
                                   placeholder="The Shattered Crown" maxlength="50">
                            <small>Give your adventure a memorable name</small>
                        </div>

                        <div class="form-group">
                            <label for="world-seed">World Seed</label>
                            <input type="text" id="world-seed" name="worldSeed" 
                                   placeholder="mystical_forests_47291" maxlength="30">
                            <small>Optional: Custom seed for world generation (leave blank for random)</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Campaign Style</h3>
                        
                        <div class="form-group">
                            <label for="moral-complexity">Moral Complexity</label>
                            <select id="moral-complexity" name="moralComplexity" required>
                                <option value="simple">Simple - Clear good vs evil</option>
                                <option value="nuanced" selected>Nuanced - Shades of gray with clear consequences</option>
                                <option value="morally_gray">Morally Gray - Complex choices with no clear right answer</option>
                            </select>
                            <small>How complex should moral decisions be in your campaign?</small>
                        </div>

                        <div class="form-group">
                            <label for="starting-region">Starting Region</label>
                            <select id="starting-region" name="startingRegion" required>
                                <option value="sword_coast">Sword Coast - Classic D&D adventure region</option>
                                <option value="underdark">Underdark - Dark underground realm</option>
                                <option value="feywild">Feywild - Magical fey realm</option>
                                <option value="shadowfell">Shadowfell - Dark reflection of the material plane</option>
                                <option value="elemental_planes">Elemental Planes - Raw elemental forces</option>
                                <option value="custom">Custom Region</option>
                            </select>
                            <small>Choose the starting location for your adventure</small>
                        </div>

                        <div class="form-group" id="custom-region-group" style="display: none;">
                            <label for="custom-region-name">Custom Region Name</label>
                            <input type="text" id="custom-region-name" name="customRegionName" 
                                   placeholder="The Forgotten Realms" maxlength="40">
                            <small>Name your custom starting region</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Starting Scenario</h3>
                        <div class="scenario-selection">
                            <div class="scenario-option" data-scenario="mysterious_caravan">
                                <div class="scenario-header">
                                    <h4>üöö The Mysterious Caravan</h4>
                                    <span class="scenario-difficulty">Beginner</span>
                                </div>
                                <p>A merchant caravan has gone missing on the trade routes. Investigate their disappearance and uncover a web of intrigue.</p>
                                <div class="scenario-features">
                                    <span class="feature">Investigation</span>
                                    <span class="feature">Social Encounters</span>
                                    <span class="feature">Mystery</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="goblin_raids">
                                <div class="scenario-header">
                                    <h4>‚öîÔ∏è Goblin Raids</h4>
                                    <span class="scenario-difficulty">Beginner</span>
                                </div>
                                <p>Goblin raiders threaten a peaceful village. Rally the townsfolk and drive back the goblin menace.</p>
                                <div class="scenario-features">
                                    <span class="feature">Combat</span>
                                    <span class="feature">Tactics</span>
                                    <span class="feature">Community</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="ancient_ruins">
                                <div class="scenario-header">
                                    <h4>üèõÔ∏è The Ancient Ruins</h4>
                                    <span class="scenario-difficulty">Intermediate</span>
                                </div>
                                <p>Explore forgotten ruins filled with traps, puzzles, and ancient guardians protecting lost treasures.</p>
                                <div class="scenario-features">
                                    <span class="feature">Exploration</span>
                                    <span class="feature">Puzzles</span>
                                    <span class="feature">Treasure</span>
                                </div>
                            </div>

                            <div class="scenario-option" data-scenario="political_intrigue">
                                <div class="scenario-header">
                                    <h4>üëë Court of Shadows</h4>
                                    <span class="scenario-difficulty">Advanced</span>
                                </div>
                                <p>Navigate the dangerous waters of noble court politics, where words are weapons and alliances shift like shadows.</p>
                                <div class="scenario-features">
                                    <span class="feature">Roleplay</span>
                                    <span class="feature">Intrigue</span>
                                    <span class="feature">Politics</span>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="selected-scenario" name="startingScenario" value="mysterious_caravan">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="secondary-button" onclick="promptToSave('mainMenu')">
                            Cancel
                        </button>
                        <button type="submit" class="primary-button">
                            <span class="button-icon">‚ú®</span>
                            Create Campaign
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Character Setup Screen -->
        <div id="characterSetup-screen" class="screen character-setup-screen">
            <div class="character-setup-container">
                <header class="screen-header">
                    <h2>Character Setup</h2>
                    <div class="header-actions">
                        <button id="import-character-btn" class="secondary-button">Import from D&D Beyond</button>
                        <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                    </div>
                </header>

                <!-- Import Character Modal -->
                <div id="import-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Import D&D Beyond Character</h3>
                            <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <p>Copy and paste your character sheet text from D&D Beyond:</p>
                            <textarea id="character-import-text" placeholder="Paste your D&D Beyond character sheet here..." rows="10"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                            <button id="parse-character-btn" class="primary-button">Parse Character</button>
                        </div>
                    </div>
                </div>

                <!-- Party Management -->
                <div class="party-management">
                    <h3>Party Members</h3>
                    <div id="party-list" class="party-list">
                        <div class="empty-party">
                            <p>No characters in party. Import or create characters to get started.</p>
                            <button class="primary-button" onclick="document.getElementById('import-modal').style.display='flex'">
                                <span class="button-icon">üë•</span>
                                Add First Character
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Character Actions -->
                <div class="character-actions" id="character-actions" style="display: none;">
                    <button id="continue-to-game-btn" class="primary-button">
                        <span class="button-icon">üéÆ</span>
                        Continue to Game
                    </button>
                </div>
            </div>
        </div>

        <!-- Character Sheet Screen -->
        <div id="characterSheet-screen" class="screen character-sheet-screen">
            <div class="character-sheet-container">
                <header class="character-sheet-header">
                    <div class="character-name-section">
                        <h2 id="character-name">Character Name</h2>
                        <div class="character-basics">
                            <span id="character-class-level">Class Level</span>
                            <span id="character-race">Race</span>
                        </div>
                    </div>
                    <div class="party-switcher">
                        <select id="character-switcher">
                            <option>Select Character</option>
                        </select>
                    </div>
                    <div class="header-actions">
                        <button id="save-character-btn" class="secondary-button">Save</button>
                        <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                    </div>
                </header>

                <!-- Character Sheet Tabs -->
                <div class="character-tabs">
                    <button class="tab-button active" data-tab="overview">Overview</button>
                    <button class="tab-button" data-tab="abilities">Abilities</button>
                    <button class="tab-button" data-tab="skills">Skills</button>
                    <button class="tab-button" data-tab="inventory">Inventory</button>
                    <button class="tab-button" data-tab="spells">Spells</button>
                    <button class="tab-button" data-tab="features">Features</button>
                    <button class="tab-button" data-tab="relationships">Relationships</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div id="overview-tab" class="tab-panel active">
                        <div class="overview-grid">
                            <div class="vital-stats">
                                <h3>Vital Stats</h3>
                                <div class="stat-row">
                                    <label>Armor Class</label>
                                    <span id="ac-value">10</span>
                                </div>
                                <div class="stat-row">
                                    <label>Hit Points</label>
                                    <div class="hp-section">
                                        <input type="number" id="current-hp" min="0">
                                        <span>/</span>
                                        <span id="max-hp">1</span>
                                    </div>
                                </div>
                                <div class="stat-row">
                                    <label>Speed</label>
                                    <span id="speed-value">30 ft</span>
                                </div>
                                <div class="stat-row">
                                    <label>Proficiency Bonus</label>
                                    <span id="prof-bonus">+2</span>
                                </div>
                            </div>

                            <div class="ability-overview">
                                <h3>Ability Scores</h3>
                                <div class="ability-grid">
                                    <div class="ability-score">
                                        <div class="ability-name">STR</div>
                                        <div class="ability-value" id="str-score">10</div>
                                        <div class="ability-modifier" id="str-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">DEX</div>
                                        <div class="ability-value" id="dex-score">10</div>
                                        <div class="ability-modifier" id="dex-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">CON</div>
                                        <div class="ability-value" id="con-score">10</div>
                                        <div class="ability-modifier" id="con-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">INT</div>
                                        <div class="ability-value" id="int-score">10</div>
                                        <div class="ability-modifier" id="int-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">WIS</div>
                                        <div class="ability-value" id="wis-score">10</div>
                                        <div class="ability-modifier" id="wis-mod">+0</div>
                                    </div>
                                    <div class="ability-score">
                                        <div class="ability-name">CHA</div>
                                        <div class="ability-value" id="cha-score">10</div>
                                        <div class="ability-modifier" id="cha-mod">+0</div>
                                    </div>
                                </div>
                            </div>

                            <div class="character-info">
                                <h3>Character Information</h3>
                                <div class="info-row">
                                    <label>Background:</label>
                                    <span id="character-background">Unknown</span>
                                </div>
                                <div class="info-row">
                                    <label>Alignment:</label>
                                    <span id="character-alignment">Unknown</span>
                                </div>
                                <div class="info-row">
                                    <label>Experience:</label>
                                    <span id="character-xp">0 XP</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Abilities Tab -->
                    <div id="abilities-tab" class="tab-panel">
                        <div class="abilities-content">
                            <div class="saving-throws">
                                <h3>Saving Throws</h3>
                                <div id="saving-throws-list" class="saves-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="ability-details">
                                <h3>Ability Score Details</h3>
                                <div id="ability-details-list" class="ability-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Tab -->
                    <div id="skills-tab" class="tab-panel">
                        <h3>Skills</h3>
                        <div id="skills-list" class="skills-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Inventory Tab -->
                    <div id="inventory-tab" class="tab-panel">
                        <div class="inventory-content">
                            <div class="weapons-section">
                                <h3>Weapons</h3>
                                <div id="weapons-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="armor-section">
                                <h3>Armor</h3>
                                <div id="armor-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="items-section">
                                <h3>Items</h3>
                                <div id="items-list" class="equipment-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="currency-section">
                                <h3>Currency</h3>
                                <div class="currency-grid">
                                    <div class="coin"><span class="coin-type">CP</span><span id="cp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">SP</span><span id="sp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">EP</span><span id="ep-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">GP</span><span id="gp-amount">0</span></div>
                                    <div class="coin"><span class="coin-type">PP</span><span id="pp-amount">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Spells Tab -->
                    <div id="spells-tab" class="tab-panel">
                        <div class="spells-content">
                            <div class="spellcasting-info">
                                <h3>Spellcasting</h3>
                                <div class="spell-stats">
                                    <div class="spell-stat">
                                        <label>Spellcasting Ability</label>
                                        <span id="spellcasting-ability">None</span>
                                    </div>
                                    <div class="spell-stat">
                                        <label>Spell Save DC</label>
                                        <span id="spell-save-dc">8</span>
                                    </div>
                                    <div class="spell-stat">
                                        <label>Spell Attack Bonus</label>
                                        <span id="spell-attack-bonus">+0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="spell-slots">
                                <h3>Spell Slots</h3>
                                <div id="spell-slots-list" class="slots-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div class="spells-known">
                                <h3>Spells Known</h3>
                                <div id="spells-list" class="spells-list">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Features Tab -->
                    <div id="features-tab" class="tab-panel">
                        <h3>Features & Traits</h3>
                        <div id="features-list" class="features-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div id="relationships-tab" class="tab-panel">
                        <div class="relationships-content">
                            <div class="backstory-section">
                                <h3>Backstory</h3>
                                <div class="backstory-item">
                                    <label>Personality Traits:</label>
                                    <div id="personality-traits" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Ideals:</label>
                                    <div id="ideals" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Bonds:</label>
                                    <div id="bonds" class="trait-list"></div>
                                </div>
                                <div class="backstory-item">
                                    <label>Flaws:</label>
                                    <div id="flaws" class="trait-list"></div>
                                </div>
                            </div>
                            <div class="notes-section">
                                <h3>Notes</h3>
                                <textarea id="character-notes" placeholder="Character notes and relationships..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Browser Screen -->
        <div id="worldBrowser-screen" class="screen world-browser-screen">
            <div class="world-browser-container">
                <header class="screen-header">
                    <h2>World Browser</h2>
                    <button class="close-button" onclick="promptToSave('mainMenu')">‚úï</button>
                </header>

                <!-- Search and Filters -->
                <div class="world-browser-filters">
                    <div class="search-section">
                        <input type="text" id="world-search" placeholder="Search NPCs, locations, factions, events..." class="search-input">
                        <button id="search-btn" class="search-button">üîç</button>
                    </div>
                    
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>Category:</label>
                            <select id="category-filter">
                                <option value="all">All</option>
                                <option value="npcs">NPCs</option>
                                <option value="locations">Locations</option>
                                <option value="factions">Factions</option>
                                <option value="events">Events</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Region:</label>
                            <select id="region-filter">
                                <option value="all">All Regions</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Status:</label>
                            <select id="status-filter">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="hostile">Hostile</option>
                                <option value="friendly">Friendly</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- World Browser Tabs -->
                <div class="world-browser-tabs">
                    <button class="world-tab-button active" data-tab="all">All</button>
                    <button class="world-tab-button" data-tab="npcs">NPCs</button>
                    <button class="world-tab-button" data-tab="locations">Locations</button>
                    <button class="world-tab-button" data-tab="factions">Factions</button>
                    <button class="world-tab-button" data-tab="events">Events</button>
                    <button class="world-tab-button" data-tab="timeline">Timeline</button>
                    <button class="world-tab-button" data-tab="relationships">Relationships</button>
                </div>

                <!-- Tab Content -->
                <div class="world-tab-content">
                    <!-- All Tab -->
                    <div id="all-world-tab" class="world-tab-panel active">
                        <div id="all-results" class="world-results-grid">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <!-- NPCs Tab -->
                    <div id="npcs-world-tab" class="world-tab-panel">
                        <div class="npc-section">
                            <div class="section-header">
                                <h3>Non-Player Characters</h3>
                                <button id="add-npc-btn" class="add-button">+ Add NPC</button>
                            </div>
                            <div id="npc-results" class="npc-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Locations Tab -->
                    <div id="locations-world-tab" class="world-tab-panel">
                        <div class="location-section">
                            <div class="section-header">
                                <h3>Locations</h3>
                                <button id="add-location-btn" class="add-button">+ Add Location</button>
                            </div>
                            <div id="location-results" class="location-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Factions Tab -->
                    <div id="factions-world-tab" class="world-tab-panel">
                        <div class="faction-section">
                            <div class="section-header">
                                <h3>Factions</h3>
                                <button id="add-faction-btn" class="add-button">+ Add Faction</button>
                            </div>
                            <div id="faction-results" class="faction-grid">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Events Tab -->
                    <div id="events-world-tab" class="world-tab-panel">
                        <div class="event-section">
                            <div class="section-header">
                                <h3>Events</h3>
                                <button id="add-event-btn" class="add-button">+ Add Event</button>
                            </div>
                            <div id="event-results" class="event-list">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div id="timeline-world-tab" class="world-tab-panel">
                        <div class="timeline-section">
                            <h3>Campaign Timeline</h3>
                            <div class="timeline-controls">
                                <button id="timeline-filter-major" class="timeline-filter">Major Events</button>
                                <button id="timeline-filter-all" class="timeline-filter active">All Events</button>
                                <select id="timeline-date-range">
                                    <option value="all">All Time</option>
                                    <option value="recent">Last 30 Days</option>
                                    <option value="session">Current Session</option>
                                </select>
                            </div>
                            <div id="timeline-results" class="timeline-container">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Relationships Tab -->
                    <div id="relationships-world-tab" class="world-tab-panel">
                        <div class="relationships-section">
                            <h3>Relationship Map</h3>
                            <div class="relationship-controls">
                                <select id="relationship-focus">
                                    <option value="all">Show All Relationships</option>
                                    <option value="party">Party Connections</option>
                                    <option value="factions">Faction Networks</option>
                                    <option value="locations">Location Connections</option>
                                </select>
                                <button id="relationship-reset" class="secondary-button">Reset View</button>
                            </div>
                            <div id="relationship-map" class="relationship-map">
                                <!-- Populated by JavaScript with visual relationship mapping -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Entity Detail Modal -->
        <div id="world-detail-modal" class="modal" style="display: none;">
            <div class="modal-content world-detail-content">
                <div class="modal-header">
                    <h3 id="detail-title">Entity Details</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body" id="detail-body">
                    <!-- Populated by JavaScript based on entity type -->
                </div>
                <div class="modal-footer">
                    <button id="edit-entity-btn" class="secondary-button">Edit</button>
                    <button class="primary-button" onclick="this.closest('.modal').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Entity Modal -->
        <div id="entity-form-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="entity-form-title">Add Entity</h3>
                    <button class="modal-close" onclick="this.closest('.modal').style.display='none'">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="entity-form">
                        <div id="entity-form-fields">
                            <!-- Populated dynamically based on entity type -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="secondary-button" onclick="this.closest('.modal').style.display='none'">Cancel</button>
                    <button id="save-entity-btn" class="primary-button">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen game-screen">
            <div class="game-container">
                <header class="game-header">
                    <h2>D&D Adventure</h2>
                    <div class="game-controls">
                        <button class="secondary-button" onclick="switchScreen('characterSheet')">Character Sheet</button>
                        <button class="secondary-button" onclick="switchScreen('worldBrowser')">World Browser</button>
                        <button class="secondary-button" onclick="promptToSave('mainMenu')">Main Menu</button>
                    </div>
                </header>
                
                <div class="game-content">
                    <div class="story-section">
                        <h3>Current Adventure</h3>
                        <div id="story-text" class="story-text">
                            <p>Welcome to your D&D adventure! Your party stands at the edge of a mysterious forest, ready to begin their epic journey.</p>
                        </div>
                    </div>
                    
                    <div class="game-interface">
                        <div class="party-status">
                            <h4>Party Status</h4>
                            <div id="game-party-list" class="game-party-list">
                                <!-- Party members will be populated here -->
                            </div>
                        </div>
                        
                        <div class="action-section">
                            <h4>Actions</h4>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="alert('Combat system coming soon!')">‚öîÔ∏è Combat</button>
                                <button class="action-btn" onclick="alert('Exploration system coming soon!')">üó∫Ô∏è Explore</button>
                                <button class="action-btn" onclick="alert('Rest system coming soon!')">üèïÔ∏è Rest</button>
                                <button class="action-btn" onclick="alert('Inventory system coming soon!')">üéí Inventory</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Simple button handlers that work immediately -->
    <script>
        // Simple screen switching function that works without modules
        function switchScreen(screenName) {
            console.log('Switching to screen:', screenName);
            
            // Hide all screens
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.style.display = 'none';
                screen.classList.remove('active');
            });
            
            // Show the target screen
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.style.display = 'block';
                targetScreen.classList.add('active');
                console.log('Screen shown:', screenName);
            } else {
                console.error('Screen not found:', screenName);
            }
        }
        
        // Add click handlers when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up button handlers...');
            
            // Create New Campaign button
            const createBtn = document.getElementById('create-campaign-btn');
            if (createBtn) {
                createBtn.onclick = function() {
                    console.log('Create Campaign clicked');
                    switchScreen('campaignCreation');
                };
                console.log('Create Campaign button handler attached');
            }
            
            // Continue Campaign button
            const continueBtn = document.getElementById('continue-campaign-btn');
            if (continueBtn) {
                continueBtn.onclick = function() {
                    console.log('Continue Campaign clicked');
                    showCampaignList();
                };
                console.log('Continue Campaign button handler attached');
            }
            
            // Load from GitHub button
            const githubBtn = document.getElementById('load-github-btn');
            if (githubBtn) {
                githubBtn.onclick = function() {
                    console.log('Load from GitHub clicked');
                    alert('GitHub integration will be available soon!');
                };
                console.log('GitHub button handler attached');
            }
            
            // World Browser button
            const worldBtn = document.getElementById('world-browser-btn');
            if (worldBtn) {
                worldBtn.onclick = function() {
                    console.log('World Browser clicked');
                    switchScreen('worldBrowser');
                };
                console.log('World Browser button handler attached');
            }
            
            // Settings button
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.onclick = function() {
                    console.log('Settings clicked');
                    switchScreen('settings');
                };
                console.log('Settings button handler attached');
            }
            
            console.log('All button handlers set up');
        });
        
        // Campaign creation function
        function createCampaign(event) {
            event.preventDefault(); // Prevent form submission
            console.log('Creating campaign...');
            
            // Get form data
            const form = document.getElementById('campaign-creation-form');
            const formData = new FormData(form);
            const campaignData = {
                id: 'campaign_' + Date.now(),
                name: formData.get('campaignName'),
                worldSeed: formData.get('worldSeed'),
                moralComplexity: formData.get('moralComplexity'),
                startingRegion: formData.get('startingRegion'),
                startingScenario: formData.get('startingScenario'),
                createdDate: new Date().toISOString(),
                lastPlayed: new Date().toISOString(),
                characters: [],
                gameState: {
                    currentLocation: 'Starting Region',
                    storyProgress: 0,
                    completedQuests: [],
                    activeQuests: []
                }
            };
            
            console.log('Campaign data:', campaignData);
            
            // Save campaign to localStorage
            saveCampaign(campaignData);
            
            // Set as current campaign
            window.currentCampaign = campaignData;
            
            // Show character setup screen
            switchScreen('characterSetup');
            
            // Show success message
            alert('Campaign "' + campaignData.name + '" created successfully!');
        }
        
        // Save campaign to localStorage
        function saveCampaign(campaignData) {
            try {
                // Get existing campaigns
                let campaigns = JSON.parse(localStorage.getItem('dnd_campaigns')) || [];
                
                // Find existing campaign or add new one
                const existingIndex = campaigns.findIndex(c => c.id === campaignData.id);
                if (existingIndex >= 0) {
                    campaigns[existingIndex] = campaignData;
                    console.log('Updated existing campaign:', campaignData.name);
                } else {
                    campaigns.push(campaignData);
                    console.log('Added new campaign:', campaignData.name);
                }
                
                // Save to localStorage
                localStorage.setItem('dnd_campaigns', JSON.stringify(campaigns));
                console.log('Campaign saved to localStorage');
                
                return true;
            } catch (error) {
                console.error('Error saving campaign:', error);
                return false;
            }
        }
        
        // Load campaigns from localStorage
        function loadCampaigns() {
            try {
                return JSON.parse(localStorage.getItem('dnd_campaigns')) || [];
            } catch (error) {
                console.error('Error loading campaigns:', error);
                return [];
            }
        }
        
        // Save current campaign data (characters, progress, etc.)
        function saveCurrentCampaignData() {
            if (window.currentCampaign) {
                // Update campaign with current party data
                if (window.partyCharacters) {
                    window.currentCampaign.characters = window.partyCharacters;
                }
                
                // Update last played timestamp
                window.currentCampaign.lastPlayed = new Date().toISOString();
                
                // Save to localStorage
                const success = saveCampaign(window.currentCampaign);
                if (success) {
                    console.log('Current campaign data saved');
                    return true;
                } else {
                    console.error('Failed to save current campaign data');
                    return false;
                }
            }
            return false;
        }
        
        // Prompt to save before navigating away
        function promptToSave(targetScreen) {
            if (window.currentCampaign && targetScreen === 'mainMenu') {
                const shouldSave = confirm('Do you want to save your current campaign progress before returning to the main menu?');
                if (shouldSave) {
                    const saved = saveCurrentCampaignData();
                    if (saved) {
                        alert('Campaign saved successfully!');
                    } else {
                        alert('Failed to save campaign. Please try again.');
                        return; // Don't navigate if save failed
                    }
                }
                
                // Clear current campaign when going to main menu
                window.currentCampaign = null;
                window.partyCharacters = [];
            }
            
            // Proceed with navigation
            switchScreen(targetScreen);
        }
        
        // Character parsing function
        function parseCharacterSheet() {
            const textarea = document.getElementById('character-import-text');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please paste character sheet data first!');
                return;
            }
            
            console.log('Parsing character sheet...');
            
            try {
                const character = parseCharacterData(text);
                console.log('Parsed character:', character);
                
                // Add character to party
                addCharacterToParty(character);
                
                // Close the modal
                document.getElementById('import-modal').style.display = 'none';
                
                // Clear the textarea
                textarea.value = '';
                
                alert('Character "' + character.name + '" imported successfully!');
                
            } catch (error) {
                console.error('Error parsing character:', error);
                alert('Error parsing character sheet. Please check the format.');
            }
        }
        
        // Parse the character data from the text format
        function parseCharacterData(text) {
            const lines = text.split('\n');
            const character = {
                // Basic info
                name: '',
                class: '',
                level: 1,
                species: '',
                background: '',
                alignment: '',
                
                // Ability scores
                abilities: {
                    strength: 10, dexterity: 10, constitution: 10,
                    intelligence: 10, wisdom: 10, charisma: 10
                },
                
                // Combat stats
                combat: {
                    armorClass: 10,
                    hitPoints: { current: 1, max: 1 },
                    initiative: 0,
                    speed: 30,
                    proficiencyBonus: 2
                },
                
                // Skills and saves
                savingThrows: {},
                skills: {},
                
                // Equipment and weapons
                weapons: [],
                equipment: {},
                
                // Features and traits
                features: [],
                
                // Other data
                proficiencies: {
                    armor: '', weapons: '', tools: '', languages: ''
                },
                personality: {
                    traits: '', ideals: '', bonds: '', flaws: ''
                },
                currency: {
                    cp: 0, sp: 0, ep: 0, gp: 0, pp: 0
                }
            };
            
            let currentSection = '';
            
            for (let line of lines) {
                line = line.trim();
                
                // Skip comments and empty lines
                if (line.startsWith('#') || !line) continue;
                
                // Check for section headers
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.slice(1, -1);
                    continue;
                }
                
                // Parse key=value pairs
                if (line.includes('=')) {
                    const [key, value] = line.split('=', 2);
                    const cleanKey = key.trim();
                    const cleanValue = value.trim();
                    
                    switch (currentSection) {
                        case 'CHARACTER_INFO':
                            if (cleanKey === 'name') character.name = cleanValue;
                            else if (cleanKey === 'class') character.class = cleanValue;
                            else if (cleanKey === 'level') character.level = parseInt(cleanValue);
                            else if (cleanKey === 'species') character.species = cleanValue;
                            else if (cleanKey === 'background') character.background = cleanValue;
                            else if (cleanKey === 'alignment') character.alignment = cleanValue;
                            break;
                            
                        case 'ABILITY_SCORES':
                            if (cleanKey in character.abilities) {
                                character.abilities[cleanKey] = parseInt(cleanValue);
                            }
                            break;
                            
                        case 'COMBAT_STATS':
                            if (cleanKey === 'armor_class') character.combat.armorClass = parseInt(cleanValue);
                            else if (cleanKey === 'hit_points_max') character.combat.hitPoints.max = parseInt(cleanValue);
                            else if (cleanKey === 'hit_points_current') character.combat.hitPoints.current = parseInt(cleanValue);
                            else if (cleanKey === 'initiative') character.combat.initiative = cleanValue;
                            else if (cleanKey === 'speed') character.combat.speed = parseInt(cleanValue);
                            else if (cleanKey === 'proficiency_bonus') character.combat.proficiencyBonus = cleanValue;
                            break;
                            
                        case 'SAVING_THROWS':
                            character.savingThrows[cleanKey] = cleanValue;
                            break;
                            
                        case 'SKILLS':
                            character.skills[cleanKey] = cleanValue;
                            break;
                            
                        case 'WEAPONS':
                            if (cleanKey.startsWith('weapon_')) {
                                const weaponData = cleanValue.split(',');
                                if (weaponData.length >= 3) {
                                    character.weapons.push({
                                        name: weaponData[0],
                                        attackBonus: weaponData[1],
                                        damage: weaponData[2],
                                        properties: weaponData[3] || ''
                                    });
                                }
                            }
                            break;
                            
                        case 'EQUIPMENT':
                            if (!cleanKey.includes('_qty') && !cleanKey.includes('total_') && !cleanKey.includes('encumbered') && !cleanKey.includes('max_carry')) {
                                const equipData = cleanValue.split(',');
                                character.equipment[cleanKey] = {
                                    quantity: parseInt(equipData[0]) || 1,
                                    weight: parseInt(equipData[1]) || 0
                                };
                            }
                            break;
                            
                        case 'PROFICIENCIES':
                            if (cleanKey === 'armor') character.proficiencies.armor = cleanValue;
                            else if (cleanKey === 'weapons') character.proficiencies.weapons = cleanValue;
                            else if (cleanKey === 'tools') character.proficiencies.tools = cleanValue;
                            else if (cleanKey === 'languages') character.proficiencies.languages = cleanValue;
                            break;
                            
                        case 'PERSONALITY':
                            if (cleanKey === 'personality_traits') character.personality.traits = cleanValue;
                            else if (cleanKey === 'ideals') character.personality.ideals = cleanValue;
                            else if (cleanKey === 'bonds') character.personality.bonds = cleanValue;
                            else if (cleanKey === 'flaws') character.personality.flaws = cleanValue;
                            break;
                            
                        case 'CURRENCY':
                            if (cleanKey === 'copper_pieces') character.currency.cp = parseInt(cleanValue);
                            else if (cleanKey === 'silver_pieces') character.currency.sp = parseInt(cleanValue);
                            else if (cleanKey === 'electrum_pieces') character.currency.ep = parseInt(cleanValue);
                            else if (cleanKey === 'gold_pieces') character.currency.gp = parseInt(cleanValue);
                            else if (cleanKey === 'platinum_pieces') character.currency.pp = parseInt(cleanValue);
                            break;
                            
                        case 'FEATURES_TRAITS':
                            if (cleanValue && !cleanValue.startsWith('#')) {
                                character.features.push({
                                    name: cleanKey.replace(/_/g, ' '),
                                    description: cleanValue
                                });
                            }
                            break;
                    }
                }
            }
            
            return character;
        }
        
        // Add character to the party display
        function addCharacterToParty(character) {
            const partyList = document.getElementById('party-list');
            const emptyParty = partyList.querySelector('.empty-party');
            
            // Remove empty party message
            if (emptyParty) {
                emptyParty.remove();
            }
            
            // Create character card
            const characterCard = document.createElement('div');
            characterCard.className = 'character-card';
            characterCard.innerHTML = `
                <div class="character-info">
                    <h4>${character.name}</h4>
                    <p>Level ${character.level} ${character.species} ${character.class}</p>
                    <p>AC: ${character.combat.armorClass} | HP: ${character.combat.hitPoints.current}/${character.combat.hitPoints.max}</p>
                </div>
                <div class="character-actions">
                    <button class="secondary-button" onclick="editCharacter('${character.name}')">Edit</button>
                    <button class="secondary-button" onclick="viewCharacterSheet('${character.name}')">View Sheet</button>
                </div>
            `;
            
            partyList.appendChild(characterCard);
            
            // Show character actions section
            document.getElementById('character-actions').style.display = 'block';
            
            // Store character data (in a real app this would go to a database)
            if (!window.partyCharacters) window.partyCharacters = [];
            window.partyCharacters.push(character);
        }
        
        // View character sheet function
        function viewCharacterSheet(characterName) {
            const character = window.partyCharacters?.find(c => c.name === characterName);
            if (!character) {
                alert('Character not found!');
                return;
            }
            
            // Populate character sheet fields
            populateCharacterSheet(character);
            
            // Switch to character sheet screen
            switchScreen('characterSheet');
        }
        
        // Populate character sheet with character data
        function populateCharacterSheet(character) {
            // Basic info
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-class-level').textContent = `Level ${character.level} ${character.class}`;
            document.getElementById('character-race').textContent = character.species;
            
            // Combat stats
            document.getElementById('ac-value').textContent = character.combat.armorClass;
            document.getElementById('max-hp').textContent = character.combat.hitPoints.max;
            document.getElementById('current-hp').value = character.combat.hitPoints.current;
            document.getElementById('speed-value').textContent = character.combat.speed + ' ft';
            document.getElementById('prof-bonus').textContent = character.combat.proficiencyBonus;
            
            // Ability scores
            for (const [ability, score] of Object.entries(character.abilities)) {
                const modifier = Math.floor((score - 10) / 2);
                const modifierStr = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                
                document.getElementById(`${ability.substring(0, 3)}-score`).textContent = score;
                document.getElementById(`${ability.substring(0, 3)}-mod`).textContent = modifierStr;
            }
            
            // Add character to switcher dropdown
            const switcher = document.getElementById('character-switcher');
            if (switcher && !Array.from(switcher.options).some(opt => opt.value === character.name)) {
                const option = document.createElement('option');
                option.value = character.name;
                option.textContent = character.name;
                option.selected = true;
                switcher.appendChild(option);
            }
            
            console.log('Character sheet populated for:', character.name);
        }
        
        // Edit character function (placeholder)
        function editCharacter(characterName) {
            alert('Edit character functionality will be available soon!');
        }
        
        // Load and display saved campaigns
        function showCampaignList() {
            const campaigns = loadCampaigns();
            const contentDiv = document.getElementById('campaign-list-content');
            
            if (campaigns.length === 0) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No saved campaigns found.</p>
                        <button class="primary-button" onclick="switchScreen('campaignCreation')">Create New Campaign</button>
                    </div>
                `;
            } else {
                let campaignsHTML = '<div class="campaigns-grid">';
                
                campaigns.forEach(campaign => {
                    const lastPlayed = new Date(campaign.lastPlayed).toLocaleDateString();
                    const characterCount = campaign.characters ? campaign.characters.length : 0;
                    
                    campaignsHTML += `
                        <div class="campaign-card">
                            <div class="campaign-info">
                                <h3>${campaign.name}</h3>
                                <p><strong>Region:</strong> ${campaign.startingRegion}</p>
                                <p><strong>Characters:</strong> ${characterCount}</p>
                                <p><strong>Last Played:</strong> ${lastPlayed}</p>
                            </div>
                            <div class="campaign-actions">
                                <button class="primary-button" onclick="loadCampaign('${campaign.id}')">Continue</button>
                                <button class="secondary-button" onclick="deleteCampaign('${campaign.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
                
                campaignsHTML += '</div>';
                campaignsHTML += `
                    <div class="campaign-list-actions">
                        <button class="primary-button" onclick="switchScreen('campaignCreation')">Create New Campaign</button>
                    </div>
                `;
                
                contentDiv.innerHTML = campaignsHTML;
            }
            
            switchScreen('campaignList');
        }
        
        // Load a specific campaign
        function loadCampaign(campaignId) {
            const campaigns = loadCampaigns();
            const campaign = campaigns.find(c => c.id === campaignId);
            
            if (campaign) {
                console.log('Loading campaign:', campaign.name);
                
                // Set as current campaign
                window.currentCampaign = campaign;
                
                // Load characters into party
                if (campaign.characters && campaign.characters.length > 0) {
                    window.partyCharacters = campaign.characters;
                    
                    // Go directly to game if characters exist
                    populateGameScreen();
                    switchScreen('game');
                } else {
                    // Go to character setup if no characters
                    switchScreen('characterSetup');
                }
                
                alert('Loaded campaign: ' + campaign.name);
            } else {
                alert('Campaign not found!');
            }
        }
        
        // Delete a campaign
        function deleteCampaign(campaignId) {
            if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                let campaigns = loadCampaigns();
                campaigns = campaigns.filter(c => c.id !== campaignId);
                localStorage.setItem('dnd_campaigns', JSON.stringify(campaigns));
                
                // Refresh the campaign list
                showCampaignList();
                
                alert('Campaign deleted successfully.');
            }
        }
        
        // Continue to game function
        function continueToGame() {
            console.log('Continuing to game...');
            
            // Save current party to campaign
            if (window.currentCampaign) {
                saveCurrentCampaignData();
            }
            
            // Populate game screen with party data
            populateGameScreen();
            
            // Switch to game screen
            switchScreen('game');
        }
        
        // Populate game screen with party data
        function populateGameScreen() {
            const gamePartyList = document.getElementById('game-party-list');
            if (gamePartyList && window.partyCharacters && window.partyCharacters.length > 0) {
                gamePartyList.innerHTML = '';
                window.partyCharacters.forEach(character => {
                    const partyMember = document.createElement('div');
                    partyMember.className = 'party-member';
                    partyMember.innerHTML = `
                        <div class="member-info">
                            <strong>${character.name}</strong>
                            <span>Level ${character.level} ${character.species} ${character.class}</span>
                        </div>
                        <div class="member-stats">
                            <span>AC: ${character.combat.armorClass}</span>
                            <span>HP: ${character.combat.hitPoints.current}/${character.combat.hitPoints.max}</span>
                        </div>
                    `;
                    gamePartyList.appendChild(partyMember);
                });
            }
        }
        
        // Add event listeners when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up additional button handlers...');
            
            // Parse character button
            const parseBtn = document.getElementById('parse-character-btn');
            if (parseBtn) {
                parseBtn.onclick = parseCharacterSheet;
                console.log('Parse character button handler attached');
            }
            
            // Continue to game button
            const continueBtn = document.getElementById('continue-to-game-btn');
            if (continueBtn) {
                continueBtn.onclick = continueToGame;
                console.log('Continue to game button handler attached');
            }
            
            // Import character button (opens modal)
            const importBtn = document.getElementById('import-character-btn');
            if (importBtn) {
                importBtn.onclick = function() {
                    document.getElementById('import-modal').style.display = 'flex';
                };
                console.log('Import character button handler attached');
            }
            
            // Test GitHub connection button
            const testGitHubBtn = document.getElementById('test-github-connection');
            if (testGitHubBtn) {
                testGitHubBtn.onclick = function() {
                    alert('GitHub connection test - feature coming soon!');
                };
                console.log('Test GitHub connection button handler attached');
            }
            
            // Save character button
            const saveCharBtn = document.getElementById('save-character-btn');
            if (saveCharBtn) {
                saveCharBtn.onclick = function() {
                    alert('Character saved successfully!');
                };
                console.log('Save character button handler attached');
            }
            
            // World browser buttons
            const searchBtn = document.getElementById('search-btn');
            if (searchBtn) {
                searchBtn.onclick = function() {
                    const searchInput = document.getElementById('world-search');
                    alert('Searching for: ' + searchInput.value);
                };
                console.log('World search button handler attached');
            }
            
            // Add entity buttons (placeholder functionality)
            const addButtons = [
                'add-npc-btn', 'add-location-btn', 'add-faction-btn', 'add-event-btn'
            ];
            
            addButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.onclick = function() {
                        alert('Add ' + btnId.replace('add-', '').replace('-btn', '') + ' feature coming soon!');
                    };
                    console.log(`${btnId} handler attached`);
                }
            });
            
            console.log('All additional button handlers set up');
        });
    </script>

    <!-- Initialize Application -->
    <script type="module">
        // Check browser compatibility first
        const isModuleSupported = 'noModule' in HTMLScriptElement.prototype;
        const isFileProtocol = window.location.protocol === 'file:';
        
        if (isFileProtocol) {
            console.warn('‚ö†Ô∏è Running from file:// protocol. ES modules may not work properly.');
            console.log('üí° For full functionality, serve this app from a web server (e.g., python -m http.server)');
        }
        
        // Import the core module
        import './js/core.js';
        
        // Application initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loadingProgress = document.getElementById('loading-progress');
            const loadingText = document.getElementById('loading-text');
            const app = document.getElementById('app');
            
            function updateProgress(progress, text) {
                loadingProgress.style.width = progress + '%';
                loadingText.textContent = text;
                console.log(`üìä ${progress}%: ${text}`);
            }
            
            try {
                updateProgress(10, 'Loading ancient scrolls...');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                updateProgress(20, 'Checking browser compatibility...');
                // Browser checks
                if (window.location.protocol === 'file:') {
                    console.warn('üö® File protocol detected - this may cause issues');
                }
                
                updateProgress(30, 'Importing core modules...');
                // Wait for DNDCore to be available globally
                let attempts = 0;
                while (!window.DNDCore && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    attempts++;
                    if (attempts % 10 === 0) {
                        updateProgress(30 + (attempts / 2), `Waiting for core module... (${attempts}/100)`);
                    }
                }
                
                if (!window.DNDCore) {
                    throw new Error('DNDCore module failed to load after 5 seconds. This usually indicates a file:// protocol issue or JavaScript error.');
                }
                
                updateProgress(60, 'Core module loaded successfully');
                console.log('‚úÖ DNDCore is available');
                
                updateProgress(70, 'Initializing application modules...');
                
                // Listen for core loading progress
                window.DNDCore.on('core:loading_progress', (event) => {
                    const { loaded, total, current } = event.detail;
                    const moduleProgress = 70 + ((loaded / total) * 20);
                    updateProgress(moduleProgress, `Loading ${current}... (${loaded}/${total})`);
                });
                
                updateProgress(75, 'Starting core initialization...');
                
                // Initialize the core application with timeout
                const initPromise = window.DNDCore.init();
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Initialization timed out after 30 seconds')), 30000);
                });
                
                await Promise.race([initPromise, timeoutPromise]);
                
                updateProgress(95, 'Finalizing setup...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(100, 'Welcome, adventurer!');
                console.log('üéâ Application initialized successfully');
                
                // Hide loading screen and show app
                setTimeout(() => {
                    console.log('üé¨ Hiding loading screen');
                    loadingScreen.classList.add('fade-out');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        app.style.opacity = '1';
                        console.log('‚úÖ Application fully loaded and visible');
                    }, 500);
                }, 300);
                
            } catch (error) {
                loadingText.textContent = `Error: ${error.message}`;
                console.error('Application initialization failed:', error);
                
                // Show detailed error in the error container
                const errorContainer = document.getElementById('error-container');
                if (errorContainer) {
                    errorContainer.style.display = 'block';
                    
                    let helpText = '';
                    if (window.location.protocol === 'file:') {
                        helpText = `
                            <div class="error-help">
                                <h3>üí° Quick Fix</h3>
                                <p>You're running this from a file:// URL, which causes security restrictions.</p>
                                <p><strong>Solution:</strong> Run a local server:</p>
                                <ol>
                                    <li>Open terminal/command prompt in this folder</li>
                                    <li>Run: <code>python -m http.server 8000</code></li>
                                    <li>Open: <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></li>
                                </ol>
                                <p>Or use the provided <code>start-server.py</code> script.</p>
                            </div>
                        `;
                    }
                    
                    errorContainer.innerHTML = `
                        <div class="critical-error">
                            <h2>‚ö†Ô∏è Initialization Error</h2>
                            <p>The D&D Voice Adventure app failed to initialize.</p>
                            ${helpText}
                            <details>
                                <summary>Technical Details</summary>
                                <pre>${error.stack || error.message}</pre>
                            </details>
                            <div class="error-actions">
                                <button onclick="location.reload()">üîÑ Reload</button>
                                <button onclick="window.open('README-SERVER.md', '_blank')">üìñ Help Guide</button>
                            </div>
                        </div>
                    `;
                }
                
                // Hide loading screen after showing error
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1000);
            }
        });
        
        // Service Worker Registration for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (window.DNDCore) {
                window.DNDCore.handleCriticalError(event.error);
            }
        });
        
        // Prevent default drag and drop to avoid accidental navigation
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
    </script>
</body>
</html>